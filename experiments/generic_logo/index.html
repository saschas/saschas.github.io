<!DOCTYPE html>
<html lang="en" id="morph">
<head >
	<meta charset="UTF-8">
	<title>Sascha Sigl — Creative Coder</title>
	<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="assets/css/diesdas.css">
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68315354-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<body>
<div id="container"></div>
<div id="info">
	<p>Be relaxed and take a deep breath.</p>
	<p>Allow microphone input when you get asked.</p>
	<p>Try to blow into your microphone as strong as you can.</p>
	<br>
	<p>Can you see it?.</p>
</div>

<div id="mobile-info">
	<h1>diesdas<span>.digital</span></h1>
	<p>Be relaxed.</p>
</div>

<audio id="player" preload="auto" accept="audio/*;capture=microphone"></audio>


<div id="player_info">
	<span></span>%
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>



<script type="text/javascript" src="assets/js/orbit_controls.js"></script>

<script>
/*! modernizr 3.1.0 (Custom Build) | MIT *
 * http://modernizr.com/download/?-getusermedia-touchevents !*/
!function(e,n,t){function r(e,n){return typeof e===n}function o(){var e,n,t,o,i,s,a;for(var f in y){if(e=[],n=y[f],n.name&&(e.push(n.name.toLowerCase()),n.options&&n.options.aliases&&n.options.aliases.length))for(t=0;t<n.options.aliases.length;t++)e.push(n.options.aliases[t].toLowerCase());for(o=r(n.fn,"function")?n.fn():n.fn,i=0;i<e.length;i++)s=e[i],a=s.split("."),1===a.length?Modernizr[a[0]]=o:(!Modernizr[a[0]]||Modernizr[a[0]]instanceof Boolean||(Modernizr[a[0]]=new Boolean(Modernizr[a[0]])),Modernizr[a[0]][a[1]]=o),g.push((o?"":"no-")+a.join("-"))}}function i(e){var n=_.className,t=Modernizr._config.classPrefix||"";if(x&&(n=n.baseVal),Modernizr._config.enableJSClass){var r=new RegExp("(^|\\s)"+t+"no-js(\\s|$)");n=n.replace(r,"$1"+t+"js$2")}Modernizr._config.enableClasses&&(n+=" "+t+e.join(" "+t),x?_.className.baseVal=n:_.className=n)}function s(){return"function"!=typeof n.createElement?n.createElement(arguments[0]):x?n.createElementNS.call(n,"http://www.w3.org/2000/svg",arguments[0]):n.createElement.apply(n,arguments)}function a(e){return e.replace(/([a-z])-([a-z])/g,function(e,n,t){return n+t.toUpperCase()}).replace(/^-/,"")}function f(e,n){return function(){return e.apply(n,arguments)}}function u(e,n,t){var o;for(var i in e)if(e[i]in n)return t===!1?e[i]:(o=n[e[i]],r(o,"function")?f(o,t||n):o);return!1}function l(e,n){return!!~(""+e).indexOf(n)}function d(e){return e.replace(/([A-Z])/g,function(e,n){return"-"+n.toLowerCase()}).replace(/^ms-/,"-ms-")}function c(){var e=n.body;return e||(e=s(x?"svg":"body"),e.fake=!0),e}function p(e,t,r,o){var i,a,f,u,l="modernizr",d=s("div"),p=c();if(parseInt(r,10))for(;r--;)f=s("div"),f.id=o?o[r]:l+(r+1),d.appendChild(f);return i=s("style"),i.type="text/css",i.id="s"+l,(p.fake?p:d).appendChild(i),p.appendChild(d),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(n.createTextNode(e)),d.id=l,p.fake&&(p.style.background="",p.style.overflow="hidden",u=_.style.overflow,_.style.overflow="hidden",_.appendChild(p)),a=t(d,e),p.fake?(p.parentNode.removeChild(p),_.style.overflow=u,_.offsetHeight):d.parentNode.removeChild(d),!!a}function m(n,r){var o=n.length;if("CSS"in e&&"supports"in e.CSS){for(;o--;)if(e.CSS.supports(d(n[o]),r))return!0;return!1}if("CSSSupportsRule"in e){for(var i=[];o--;)i.push("("+d(n[o])+":"+r+")");return i=i.join(" or "),p("@supports ("+i+") { #modernizr { position: absolute; } }",function(e){return"absolute"==getComputedStyle(e,null).position})}return t}function v(e,n,o,i){function f(){d&&(delete j.style,delete j.modElem)}if(i=r(i,"undefined")?!1:i,!r(o,"undefined")){var u=m(e,o);if(!r(u,"undefined"))return u}for(var d,c,p,v,h,g=["modernizr","tspan"];!j.style;)d=!0,j.modElem=s(g.shift()),j.style=j.modElem.style;for(p=e.length,c=0;p>c;c++)if(v=e[c],h=j.style[v],l(v,"-")&&(v=a(v)),j.style[v]!==t){if(i||r(o,"undefined"))return f(),"pfx"==n?v:!0;try{j.style[v]=o}catch(y){}if(j.style[v]!=h)return f(),"pfx"==n?v:!0}return f(),!1}function h(e,n,t,o,i){var s=e.charAt(0).toUpperCase()+e.slice(1),a=(e+" "+b.join(s+" ")+s).split(" ");return r(n,"string")||r(n,"undefined")?v(a,n,o,i):(a=(e+" "+T.join(s+" ")+s).split(" "),u(a,n,t))}var g=[],y=[],C={_version:"3.1.0",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,n){var t=this;setTimeout(function(){n(t[e])},0)},addTest:function(e,n,t){y.push({name:e,fn:n,options:t})},addAsyncTest:function(e){y.push({name:null,fn:e})}},Modernizr=function(){};Modernizr.prototype=C,Modernizr=new Modernizr;var _=n.documentElement,x="svg"===_.nodeName.toLowerCase(),w=C._config.usePrefixes?" -webkit- -moz- -o- -ms- ".split(" "):[];C._prefixes=w;var S="Moz O ms Webkit",b=C._config.usePrefixes?S.split(" "):[];C._cssomPrefixes=b;var z=function(n){var r,o=w.length,i=e.CSSRule;if("undefined"==typeof i)return t;if(!n)return!1;if(n=n.replace(/^@/,""),r=n.replace(/-/g,"_").toUpperCase()+"_RULE",r in i)return"@"+n;for(var s=0;o>s;s++){var a=w[s],f=a.toUpperCase()+"_"+r;if(f in i)return"@-"+a.toLowerCase()+"-"+n}return!1};C.atRule=z;var T=C._config.usePrefixes?S.toLowerCase().split(" "):[];C._domPrefixes=T;var E={elem:s("modernizr")};Modernizr._q.push(function(){delete E.elem});var j={style:E.elem.style};Modernizr._q.unshift(function(){delete j.style});var N=C.testStyles=p;Modernizr.addTest("touchevents",function(){var t;if("ontouchstart"in e||e.DocumentTouch&&n instanceof DocumentTouch)t=!0;else{var r=["@media (",w.join("touch-enabled),("),"heartz",")","{#modernizr{top:9px;position:absolute}}"].join("");N(r,function(e){t=9===e.offsetTop})}return t}),C.testAllProps=h;var P=C.prefixed=function(e,n,t){return 0===e.indexOf("@")?z(e):(-1!=e.indexOf("-")&&(e=a(e)),n?h(e,n,t):h(e,"pfx"))};Modernizr.addTest("getusermedia",!!P("getUserMedia",navigator)),o(),i(g),delete C.addTest,delete C.addAsyncTest;for(var k=0;k<Modernizr._q.length;k++)Modernizr._q[k]();e.Modernizr=Modernizr}(window,document);
//___________________________________________ Audio


var context;

var å = {
	particles : {},
	live_input : false
}

var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();
var offset = new THREE.Vector3();
var INTERSECTED, SELECTED;
var drag_objects = [];
var collision_objects = [];
var objects_to_update = [];


var colors = [];
var digital_colors = [];
var particleSystem_1,
	digital_particles;

var $loop;         // runtime
var analyser,      // holds the context
    frequencyData, // the data Array -> Uint8Array[1024]
    bufferLength,  // 1024
    processor,
    recorder,
    source;        // the audio source
var drag_objects = [];
var $player = $("#player");

var $player_info =$('#player_info span');

var $data = [];
var $audioData = [];


var capture_setting = { 
    video: false,
    audio: true
}

//___________________________________________ HELPER FUNCTIONS
Number.prototype.clamp = function(min, max) {
  return Math.min(Math.max(this, min), max);
};

if (!window.cancelAnimationFrame)
  window.cancelAnimationFrame = function (id) {
    clearTimeout(id);
};


function randomNumber(min,max,bool){
  var num = Math.floor(Math.random()*max) + min; // this will get a number between 1 and 99;
  if(bool || typeof bool == "undefined"){
    num *= Math.floor(Math.random()*2.0) == 1.0 ? 1.0 : -1.0;
  }
  return num;
}
var clamp = function(num, min, max) {
    return num < min ? min : (num > max ? max : num);
};

function get_Color_Percentage(num){
	return num * 250 / 100;
}

// Check of point is in radius
function pointInCircle(point,target, radius) {
  var distsq = (point.x - target.x) * (point.x - target.x) + (point.y - target.y) * (point.y - target.y) + (point.z - target.z) * (point.z - target.z);
  return [distsq <= radius * radius * radius,distsq];
}

//___________________________________________ SETUP FUNCTIONS

//________________________ Navigator
if (Modernizr.getusermedia){
  var gUM = Modernizr.prefixed('getUserMedia', navigator);
  navigator.getUserMedia = ( navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
	
context();
	
	å.live_input = true;
}
else{
	å.live_input = false;
}

//________________________ AUDIO CONTEXT
function context(){
	if(typeof AudioContext !== "undefined"){
	  context = new AudioContext();
	}
	else if (typeof webkitAudioContext !== "undefined"){
	  context = new webkitAudioContext();
	}
	else {
	  console.log('sorry AudioContext is not supported! Please view this pen with Chrome')
	}

}

 




//___________________________________________ Audio Setup


function setup(){
	$player_source = $player.get(0);
    analyser = context.createAnalyser();
	analyser.fftSize = 2048;
    frequencyData = new Uint8Array(analyser.frequencyBinCount);
    bufferLength = analyser.frequencyBinCount;

    //________________________ Sourve
    source = context.createMediaElementSource($player_source);
    source.connect(analyser);
}

if(å.live_input){
	
}

////////////////////////
// the Loop 
//////////////////////////

function capture(data) {

    source = context.createMediaStreamSource(data);
    audio_data = data;

    analyser= context.createAnalyser();
    analyser.getByteFrequencyData(frequencyData);
    
var realtimeData = new Uint8Array(analyser.frequencyBinCount);
    source.connect(analyser);
    analyser.connect(processor);
    processor.connect(context.destination);
}

function onError(e) {
    console.log(e);
}

function update() {
    analyser.getByteTimeDomainData(frequencyData);
	
    //$loop = requestAnimationFrame(update);
}

///////////////////////////////////////////////
// Bind to audio
// if audio is ready to play 
///////////////////////////////////////////////


$player.bind({
  progress: function(e){
  //  console.log(e);
  },
  canplaythrough: function() {
    $('.play-button').addClass('canplay');
  },
  play: function(){
    // Kick off the visualisation
    //
    
  },
  pause : function(){
    cancelAnimationFrame($loop);
    console.log($audioData);
  },
  ended :function(){
    $('.play-button').removeClass('on');
  }
});



function connect(){
	setup();
  processor = context.createScriptProcessor(analyser.fftSize, 1, 1);
  navigator.getUserMedia(capture_setting,capture,onError);
  $loop = update();
}


function disconnect(){
 processor.onaudioprocess = null;
 audio_data.stop();
 source.disconnect();
}

//___________________________________________


//___________________________________________ Variables
var main_color = 0x000000;
var helper;

var clock = new THREE.Clock();

var mesh,stone;
var particleSystem_1;
var stone_animation;
var morph_animation;
var canvas_height = window.innerHeight;
var canvas_width = window.innerWidth;


//___________________________________________ Scene
var scene = new THREE.Scene();

	//scene.fog = new THREE.FogExp2(0x000000,.01);
//___________________________________________ CAmera
var camera = new THREE.PerspectiveCamera( 55, canvas_width/canvas_height, 0.1, 1000 );
	camera.position.set(0,0,150);

	if(!å.live_input){
		camera.position.set(0,400,150);

	}
  
scene.add(camera);
//___________________________________________ Renderer

var renderer = new THREE.WebGLRenderer({ alpha: true }); /// { alpha: true }
    renderer.setSize( canvas_width, canvas_height );
    renderer.setClearColor(0x878374,1);
	
	renderer.domElement.addEventListener( 'mousemove', onDocumentMouseMove, false );
	renderer.domElement.addEventListener( 'mousedown', onDocumentMouseDown, false );
	renderer.domElement.addEventListener( 'mouseup', onDocumentMouseUp, false );
    document.body.appendChild( renderer.domElement );


//___________________________________________ REsize
window.onresize = function(){
  canvas_height = window.innerHeight;
  canvas_width = window.innerWidth;
  camera.aspect = canvas_width / canvas_height;
  camera.updateProjectionMatrix();
  renderer.setSize( canvas_width, canvas_height );
}

//___________________________________________ MIRROR


//___________________________________________ CONTROLS

  controls = new THREE.OrbitControls( camera );

  controls.damping = 0.2;
  controls.target.set(0,5,0);
  camera.lookAt(new THREE.Vector3(0,0,0));
  controls.minDistance = 200;
  controls.maxDistance = 500;
  controls.update();

//___________________________________________ INvisible Plain
var plane = new THREE.Mesh(
					new THREE.PlaneBufferGeometry( 2000, 2000, 8, 8 ),
					new THREE.MeshBasicMaterial({ 
            color: 0x000000, 
            opacity: 0.25, 
            transparent: true 
   })
);
		plane.visible = false;
		scene.add( plane );





var group = new THREE.Group();

//___________________________________________ Loader

var loader = new THREE.JSONLoader();


var camera_helper_material = new THREE.MeshBasicMaterial({
	color: 0x0000ff
});

var radius = 250;
var segments = 32;

var circleGeometry = new THREE.CircleGeometry( radius, segments );
var camera_helper = new THREE.Mesh( circleGeometry,camera_helper_material );
camera_helper.position.z = 18;
camera_helper.visible = false;
scene.add( camera_helper );

camera_helper.add(camera);

//___________________________________________ SET COLOR
function set_particle_color(y){
	var col;
	if(y >= 50){
		col = new THREE.Color(0x32223A);
	}
	else if(y >= 30){
		col = new THREE.Color(0xE1CEAA);
	}
	else if(y <= 10){
		col = new THREE.Color(0x878374);
	}
	else{
		col = new THREE.Color(0xB4A98F);
	}

	return col;
}


function centerPoint(pointA, pointB, percentage) {

      var dir = pointB.clone().sub(pointA);
      var len = dir.length();
      dir = dir.normalize().multiplyScalar(len * percentage);
      return pointA.clone().add(dir);

    }

//___________________________________________ 

var sphere_geometry = new THREE.BoxGeometry( 50, 50, 50 );
var sphere_material = new THREE.MeshLambertMaterial({
  //color: 0xeeeeee,
  emissive: 0xE1CEAA,
  transparent:true,
  opacity:.1,
  blending : THREE.Multiply

});


var sphere = new THREE.Mesh( sphere_geometry,sphere_material );
    sphere.receiveShadow = true;
    sphere.castShadow = true;
    sphere.position.y = 30;
    sphere.position.z = -8;
    sphere.position.x = 150;
sphere.visible = false;
   
    
    sphere.direction = {
      x : 1,
      y : 1,
      z : 1
    }
    sphere.update = function(time){      
      if(this.position.x > 150){
        this.position.x = 150; 
        this.direction.x *= -1;
      }
      if(this.position.x < -150){
      	this.position.x = -150;
      	this.direction.x *= -1;
      }
	
	if(!å.live_input){
      this.position.x += 1 * this.direction.x;
     }
    }
    
    scene.add( sphere );
    drag_objects.push( sphere );


    //___________________________________________ diesdas

    //22299 > 100%
    function check_camera_rot(max){
    	return( max * 100 / 28020).toFixed(0);
	}
	loader.load("assets/model/diesdas2.json", function (geometry) {
	
		
		å.particles = geometry;
		var points = [];

		var particles = new THREE.Geometry();

		var distortion = [];

		var pMaterial = new THREE.PointCloudMaterial({
			  size: 1,
			  vertexColors: true,
			  overdraw:true,
			  transparent:true,
			  blending: THREE.NormalBlending
			 });
		var factor = 10;

		if(!å.live_input){
			factor = 2;
		}
		for(var i=0;i<geometry.vertices.length;i++){

			for(var p=0;p<factor;p++){
			  var x = geometry.vertices[i].x ;//+ randomNumber(.1,2.5,true);
			  var y = geometry.vertices[i].y + randomNumber(1,2,true);
			  var z = geometry.vertices[i].z ;//+ randomNumber(.1,2.5,true);

			  particles.vertices.push(new THREE.Vector3(x,y,z));
			 distortion.push({
			 	x : i * randomNumber(.01,.5,true),
			 	y : i * randomNumber(.01,.5,true),
			 	z : i * randomNumber(.01,.5,true)
			 })

			 colors.push(new THREE.Color(0x2E8572));
        
			}
		}

		particleSystem_1 = new THREE.PointCloud(particles,pMaterial);
		particleSystem_1.castShadow = true;
		particleSystem_1.geometry.colors = colors;
        particleSystem_1.geometry.colorsNeedUpdate = true;

		particleSystem_1.update = function(time){
			var count = 0;
			var that = this;
			var max_count = 0;
			
			if(å.live_input){
				this.geometry.vertices.forEach(function(p,index){
					if(count > frequencyData.length){
						count = 0;
					}

					p.y = clamp(frequencyData[count],1,50);


					radius_checker = pointInCircle({
					  x : p.x,
					  y : 30,
					  z : 0
					},sphere.position, 8.5);


					that.geometry.colors[index] = set_particle_color(p.y);

					if(radius_checker[0]){

						that.geometry.colors[index] = new THREE.Color(0x32223A);
						p.y = 10;
						////console.log('hit');
					}

					if(p.y>=50){
						max_count++
					}

					count++;

				});
				that.geometry.verticesNeedUpdate = true;
				that.geometry.colorsNeedUpdate = true;
				var percentage_goal = check_camera_rot(max_count);
				 $player_info.text(percentage_goal)

				camera_helper.rotation.x = -percentage_goal * Math.PI / 180;
			}
			else{
				this.geometry.vertices.forEach(function(p,index){
					if(count > that.geometry.vertices.length){
						count = 0;
					}

					p.y += randomNumber(0,150,true);


					p.y = clamp(p.y,0,50);

					radius_checker = pointInCircle({
					  x : p.x,
					  y : 30,
					  z : 0
					},sphere.position, 25);


					that.geometry.colors[index] = set_particle_color(p.y);

					if(radius_checker[0]){

						that.geometry.colors[index] = new THREE.Color(0x32223A);
						p.y = 10;
						////console.log('hit');
					}

					if(p.y>=50){
						max_count++
					}

					count++;

				});
				that.geometry.verticesNeedUpdate = true;
				that.geometry.colorsNeedUpdate = true;
				var percentage_goal = check_camera_rot(max_count);
				// $player_info.text(percentage_goal)

				//camera_helper.rotation.x = -percentage_goal * Math.PI / 180;
			}
		}
		scene.add(particleSystem_1);


		});


 //___________________________________________



if(å.live_input){
	connect();
}



//___________________________________________ Group

//group.position.z = 6.5;
//group.position.y = -2.5;
//group.position.x = -3.5;
//group.rotation.y = -30 * Math.PI / 180;
//group.rotation.x = -8 * Math.PI / 180;

//group.receiveShadow = true;
//group.castShadow = true;

scene.add(group);





function onDocumentMouseMove( event ) {
	event.preventDefault();
	mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
  
	raycaster.setFromCamera( mouse, camera );
 
	if ( SELECTED ) {
		var intersects = raycaster.intersectObject( plane );
		SELECTED.position.copy( intersects[ 0 ].point.sub( offset ) );
    	
    	SELECTED.position.y = 30;
    	SELECTED.position.z = -8;
		return;
	}
	var intersects = raycaster.intersectObjects( drag_objects );
	if ( intersects.length > 0 ) {
		if ( INTERSECTED != intersects[ 0 ].object ) {
			INTERSECTED = intersects[ 0 ].object;
			plane.position.copy( INTERSECTED.position );
			plane.lookAt( camera.position );
		}


	} else {
		INTERSECTED = null;
	}
}

function onDocumentMouseDown( event ) {
	event.preventDefault();
	var vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 ).unproject( camera );
	var raycaster = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );
	var intersects = raycaster.intersectObjects( drag_objects );
	if ( intersects.length > 0 ) {
		controls.enabled = false;
		SELECTED = intersects[ 0 ].object;
		var intersects = raycaster.intersectObject( plane );
		offset.copy( intersects[ 0 ].point ).sub( plane.position );
	}
}

function onDocumentMouseUp( event ) {
	event.preventDefault();
	controls.enabled = true;
	if ( INTERSECTED ) {
		plane.position.copy( INTERSECTED.position );
		SELECTED = null;
	}
}




//___________________________________________ Render

var time = 0;
var render = function (time) { 
  requestAnimationFrame( render ); 
  animation(time);
  renderer.render(scene, camera);
};

//___________________________________________ Animation
function animation(time){
	
	if(å.live_input){
		analyser.getByteFrequencyData(frequencyData);
	}
	///if ( mesh != "undefined" && morph_animation != "undefined" ){		
///
	///	if(mesh.morphTargetInfluences[1] > 1 || mesh.morphTargetInfluences[1] < 0){
	///		mesh.direction *= -1; 
	///	}
///
	///	mesh.morphTargetInfluences[1] += .001 * mesh.direction;
	///	//helper.update();
///
	///}



	if(particleSystem_1 != undefined){
		particleSystem_1.update(time);
	}
	if(digital_particles != undefined){
		digital_particles.update(time);
	}

	if(sphere != undefined){
		sphere.update(time);
	}
	var delta = .75 * clock.getDelta();
        
        // update skinning

        THREE.AnimationHandler.update( delta );

        if ( helper !== undefined ){
              helper.update();
        }


        group.rotation.y += .01;
};
//___________________________________________ Start
render(time);





</script>

</body>
</html>