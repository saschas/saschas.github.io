function randNum(e,o,t){var n=Math.random()*o+e;return(t||"undefined"===t)&&(n*=1==Math.floor(2*Math.random())?1:-1),n}function centerPoint(e,o,t){var n=o.clone().sub(e),a=n.length();return n=n.normalize().multiplyScalar(a*t),e.clone().add(n)}function first_controls(e){return"first"!==e.name&&(e=null,e=new THREE.FlyControls(camera),e.movementSpeed=1e3,e.domElement=renderer.domElement,e.rollSpeed=Math.PI/24,e.autoForward=!0,e.dragToLook=!1),e}function orbit_controls(e){return e=null,scene.add(camera),e=new THREE.OrbitControls(camera),e.damping=.2,e.name="orbit",e.autoRotate=!1,e.addEventListener("change",render),camera.lookAt(new THREE.Vector3(0,0,0)),e.target=new THREE.Vector3(0,0,0),e}function vr_controls(e){å.mode.vr=!0,å.mode.desktop=!1;var o="function"==typeof e.connect;return scene.add(camera),o?e.connect():(e=null,e=new THREE.DeviceOrientationControls(camera),e.connect(),e.name="vr",å.mode.desktop||(effect=new THREE.StereoEffect(renderer),e.name="vr",effect.eyeSeparation=2,effect.setSize(window.innerWidth,window.innerHeight)),camera.lookAt(new THREE.Vector3(0,0,0))),e}function pointInCircle(e,o,t){var n=(e.x-o.x)*(e.x-o.x)+(e.y-o.y)*(e.y-o.y)+(e.z-o.z)*(e.z-o.z);return[t*t*t>=n,n]}function init(){function e(e){var o=new THREE.LineBasicMaterial({color:11534336,linewidth:2});e[0].forEach(function(t,n){var a=new THREE.Geometry,r=centerPoint(t,e[1][n],.5);a.vertices.push(new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(r.x,r.y-.1,r.z),new THREE.Vector3(e[1][n].x,e[1][n].y,e[1][n].z));var i=new THREE.Line(a,o);scene.add(i)})}function o(e){var o=new THREE.LineBasicMaterial({color:860985,linewidth:2});e.forEach(function(e,t){var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(e.x,-10,e.z));var a=new THREE.Line(n,o);scene.add(a)})}container=document.getElementById("container"),camera=new THREE.PerspectiveCamera(55,window.innerWidth/window.innerHeight,.1,1e5),camera.position.x=-46,camera.position.y=45,camera.position.z=-130,camera.move_direction=1,camera.posSpeed=.002,scene=new THREE.Scene,scene.fog=new THREE.FogExp2(16763507,.003),camera.update=function(e){if("undefined"!=typeof track&&å.track.enabled){å.track.counter<1?å.track.counter+=å.track.speed:å.track.counter=0,å.track.lookAt<=1?å.track.lookAt+=å.track.speed:å.track.lookAt=0,å.track.counter>1&&(å.track.counter=1),å.track.lookAt>1&&(å.track.lookAt=1);var o=track.getPointAt(å.track.counter),t=track_r.getPointAt(å.track.counter),n=track.getPointAt(å.track.lookAt),a=track_r.getPointAt(å.track.lookAt),r=centerPoint(o,t,.5),i=centerPoint(n,a,.5);if(this.position.copy(r),!å.mode.vr){tangent=track.getTangentAt(å.track.lookAt).normalize(),axis.crossVectors(up,tangent).normalize();var s=Math.acos(up.dot(tangent));this.quaternion.setFromAxisAngle(axis,s),this.lookAt(i)}}"undefined"!=typeof wagons&&å.rad.enabled&&(0==this.position.x&&0==this.position.y&&0==this.position.z&&(this.position.set(0,0,0),this.lookAt(new THREE.Vector3(1,0,0))),å.mode.vr||"orbit"===controls.name||(controls=orbit_controls(controls),this.position.set(0,-6,6)),0==this.position.x&&0==this.position.y&&0==this.position.z&&(this.position.set(0,0,6),this.lookAt(new THREE.Vector3(2,0,0))),controls.noZoom=!0,controls.maxDistance=.02,wagons.children[0].add(camera)),"undefined"!=typeof monster&&å.monster.enabled&&(å.mode.vr||"orbit"===controls.name||(controls=orbit_controls(controls)),0==this.position.x&&0==this.position.y&&0==this.position.z&&this.position.set(-5,-18,.1),controls.target=new THREE.Vector3(-5,-18,0),controls.noZoom=!0,controls.maxDistance=.01,monster.add(camera)),å.rad.enabled,å.explore.enabled},scene.add(camera),renderer=new THREE.WebGLRenderer({antialias:!0,transparent:!0,alpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement),renderer.shadowMapEnabled=!0,renderer.gamma,å.mode.desktop&&(controls=orbit_controls(controls)),å.mode.vr&&(controls=vr_controls(controls));var t=new THREE.AmbientLight(3355443);scene.add(t),light=new THREE.SpotLight(16099691,10,200,Math.PI/2),light.position.set(0,150,0).multiplyScalar(1),light.castShadow=!0,light.shadowMapWidth=2048,light.shadowMapHeight=2048,scene.add(light),front_light=new THREE.SpotLight(16099691,2,200,Math.PI/2),front_light.position.set(-46,45,-150).multiplyScalar(1),scene.add(front_light),fake_light=new THREE.SpotLight(4575978,1,1,Math.PI/2),fake_light.position.set(0,300,-150).multiplyScalar(1),fake_light.castShadow=!0,fake_light.shadowMapWidth=1024,fake_light.shadowMapHeight=1024;var n=3500;fake_light.shadowCameraLeft=-n,fake_light.shadowCameraRight=n,fake_light.shadowCameraTop=n,fake_light.shadowCameraBottom=-n,fake_light.shadowCameraNear=.01,scene.add(fake_light);var a=new THREE.PointLight(16777215,.1),r=new THREE.JSONLoader,i=new THREE.SubdivisionModifier(2);r.load(å.model.track,function(t){var n=[],a=[];t.vertices.forEach(function(e,o){o%2==0?n.push(e):a.push(e)}),n[n.length-1]=n[0],a[a.length-1]=a[0],track=new THREE.SplineCurve3(n),track_r=new THREE.SplineCurve3(a);var r=.2,i=6,s=new THREE.CircleGeometry(r,i),d={steps:1e3,bevelEnabled:!1,extrudePath:track},c={steps:1e3,bevelEnabled:!1,extrudePath:track_r};o(n),o(a),e([n,a]);var l=new THREE.Shape(s.vertices),m=new THREE.ExtrudeGeometry(l,d),E=new THREE.ExtrudeGeometry(l,c),h=new THREE.MeshLambertMaterial({color:11534336,wireframe:!1}),u=new THREE.Geometry,w=new THREE.Mesh(m,h),p=new THREE.Mesh(E,h);w.castShadow=!0,w.receiveShadow=!0,p.castShadow=!0,p.receiveShadow=!0,scene.add(w),scene.add(p)}),r.load(å.model.rad_ground,function(e,o){o.forEach(function(e,o){e.shading=THREE.FlatShading});var t=new THREE.MeshFaceMaterial(o);rad_ground=new THREE.Mesh(e,t),rad_ground.position.y=-3,rad_ground.position.x=27.25,rad_ground.position.z=16.5,rad_ground.rotation.y=45*Math.PI/180,rad_ground.receiveShadow=!0,rad_ground.castShadow=!0,scene.add(rad_ground)}),r.load(å.model.rad,function(e,o){o.forEach(function(e,o){e.shading=THREE.FlatShading});var t=new THREE.MeshFaceMaterial(o);e.mergeVertices(),e.computeFaceNormals(),e.computeVertexNormals(),i.modify(e),rad=new THREE.Mesh(e,t),rad.position.y=17,rad.position.x=30,rad.position.z=20,rad.rotation.y=45*Math.PI/180,rad.update=function(e){this.rotation.z+=.01},rad.castShadow=!0,rad.receiveShadow=!0,scene.add(rad)}),r.load(å.model.rad_wagon,function(e){var o=new THREE.MeshLambertMaterial({color:16777215,shading:THREE.FlatShading,side:THREE.DoubeSided});wagons=new THREE.Object3D;for(var t=0;20>t;t++)rad_wagon=new THREE.Mesh(e,o),rad_wagon.position.x=15.5*Math.sin(t),rad_wagon.position.y=15.5*Math.cos(t),rad_wagon.position.z=0,rad_wagon.update=function(e){this.rotation.z-=.01},wagons.add(rad_wagon);wagons.position.y=17,wagons.position.x=30,wagons.position.z=20,wagons.rotation.y=45*Math.PI/180,wagons.update=function(e){this.rotation.z+=.01},wagons.castShadow=!0,wagons.receiveShadow=!0,scene.add(wagons)}),r.load(å.model.monster,function(e,o){o.forEach(function(e,o){e.shading=THREE.FlatShading});var t=new THREE.MeshFaceMaterial(o);monster=new THREE.Mesh(e,t),monster.position.y=22,monster.position.x=35,monster.position.z=-23,monster.rotation.y=0*Math.PI/180,monster.rotSpeed=.01,monster.direction=1,monster.receiveShadow=!0,monster.castShadow=!0,monster.update=function(e){(this.rotation.x>1.8||this.rotation.x<-1.8)&&(this.direction*=-1),this.rotation.x+=.01*this.direction*(1.9-Math.abs(this.rotation.x)),this.rotation.y+=.01},scene.add(monster)}),r.load(å.model.monster_ground,function(e,o){o.forEach(function(e,o){e.shading=THREE.FlatShading});var t=new THREE.MeshFaceMaterial(o);monster_ground=new THREE.Mesh(e,t),monster_ground.position.y=-2,monster_ground.position.x=35,monster_ground.position.z=-23,monster_ground.rotation.y=90*Math.PI/180,monster_ground.receiveShadow=!0,scene.add(monster_ground)}),r.load(å.model.park,function(e,o){o.forEach(function(e,o){e.shading=THREE.FlatShading});var o=new THREE.MeshFaceMaterial(o);console.log(o),ground=new THREE.Mesh(e,o),ground.rotation.y=205*Math.PI/180,ground.position.y=-4.5,ground.position.z=23,ground.castShadow=!0,ground.receiveShadow=!0,scene.add(ground)}),r.load(å.model.cloud,function(e){for(var o=new THREE.MeshBasicMaterial({color:16777215}),t=[],n=new THREE.Object3D,a=0;50>a;a++)t[a]=new THREE.Mesh(e,o),t[a].rotation.y=205*a*Math.PI/180,t[a].position.y=60+Math.sin(a)*randNum(0,20,!0),t[a].position.x=Math.sin(a)*randNum(0,500,!0),t[a].position.z=Math.cos(a)*randNum(0,500,!0),t[a].castShadow=!0,t[a].receiveShadow=!0,n.add(t[a]);scene.add(n)});for(var s=new THREE.Geometry,d=new THREE.PointCloudMaterial({color:16777215,size:.2,transparent:!0,opacity:.25}),c=0;500>c;c++){var l=randNum(0,100,!0),m=randNum(0,100,!0),E=randNum(0,100,!0);s.vertices.push(new THREE.Vector3(l,m,E))}var h=new THREE.PointCloud(s,d);scene.add(h);for(var u=new THREE.Geometry,w=new THREE.PointCloudMaterial({size:1,transparent:!0,opacity:1,vertexColors:!0}),p=[],g=[4359668,3450963,,16497669,15352629,16777215],f=[],c=0;500>c;c++){var l=randNum(0,.05,!0),m=randNum(.1,.25,!1),E=randNum(0,.05,!0);u.vertices.push(new THREE.Vector3(0,0,0)),f.push(new THREE.Vector3(l,m,E)),p.push(new THREE.Color(g[Math.floor(Math.random()*g.length)]))}konfSystem=new THREE.PointCloud(u,w),konfSystem.turbulence=f,console.log(konfSystem),konfSystem.geometry.colors=p,konfSystem.geometry.colorsNeedUpdate=!0,konfSystem.position.set(-40,0,-55),konfSystem.update=function(e){var o=this;this.geometry.vertices.forEach(function(e,t){e.x+=o.turbulence[t].x,e.y+=o.turbulence[t].y,e.z+=o.turbulence[t].z;var n=pointInCircle({x:0,y:0,z:0},e,randNum(9,15));n[0]||(e.x=0,e.y=0,e.z=0)}),this.geometry.verticesNeedUpdate=!0},sec_konfSystem=konfSystem.clone(),sec_konfSystem.position.set(0,0,-75),scene.add(konfSystem),scene.add(sec_konfSystem),sea_geometry=new THREE.PlaneGeometry(55,55,32,32),sea_material=new THREE.MeshPhongMaterial({color:255,transparent:!0,opacity:.85,shininess:10});for(var c=0;c<sea_geometry.vertices.length;c++)sea_geometry.vertices[c].z=1*Math.random();sea=new THREE.Mesh(sea_geometry,sea_material),sea.rotation.x=-Math.PI/2,sea.position.x=-12,sea.position.y=-7,sea.visible=!1,sea.receiveShadow=!0,scene.add(sea)}function check_Camera(e){"Scene"!==e.parent.type&&(e.clone(),THREE.SceneUtils.detach(e,e.parent,scene),scene.add(e),controls.update(),e.position.set(0,0,0))}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),å.mode.desktop&&renderer.setSize(window.innerWidth,window.innerHeight),å.mode.vr&&effect.setSize(window.innerWidth,window.innerHeight)}function animate(){requestAnimationFrame(animate),render()}function render(e){var o=.75*clock.getDelta();if(void 0!==helper&&helper.update(),konfSystem.update(e),"undefined"!=typeof rad&&(rad.update(e),wagons.update(e),wagons.children.forEach(function(o,t){o.update(e)}),monster.update(e),sea.visible=!0),å.mode.desktop&&renderer.render(scene,camera),å.mode.orientation&&effect.render(scene,camera),å.mode.desktop||!å.mode.orientation)camera.update(e);else{var o=clock.getDelta();controls.update(o)}}var container,camera,scene,controls,raycaster=new THREE.Raycaster,renderer,clock=new THREE.Clock,time=0,duration=100,keyframes=4,interpolation=duration/keyframes,currentKeyframe=0,lastKeyframe=0,animOffset=1,radius=600,theta=0,effect,prevTime=Date.now(),helper,konfSystem,sec_konfSystem,postprocessing={enabled:!0},velocity={},rad_wagon,rad,track,wagons,monster,tangent=new THREE.Vector3,axis=new THREE.Vector3,up=new THREE.Vector3(0,1,0),gras,animation,fake_light,base_url="https://s3-us-west-2.amazonaws.com/s.cdpn.io/61062/",å={rad:{enabled:!1},explore:{enabled:!1},monster:{enabled:!1},track:{enabled:!1,speed:5e-4,counter:0,lookAt:1e-5},mouse:{x:0,y:0,z:.5},mode:{desktop:!0,vr:!1,orientation:!1},postprocessing:{enabled:!0},paused:!1,state:{},scene:{},model:{track:base_url+"track.json",rad:base_url+"rad.json",rad_ground:base_url+"rad_ground.json",rad_wagon:base_url+"rad_wagon.json",monster:base_url+"monster.json",monster_ground:base_url+"monster_ground.json",park:base_url+"park.json",cloud:base_url+"cloud.json"},loaded:{}},smoke_image=document.getElementById("texture_smoke"),smoke_texture=new THREE.Texture(smoke_image);smoke_texture.needsUpdate=!0;var materialDepth,sunPosition=new THREE.Vector3(100,0,-100),screenSpacePosition=new THREE.Vector3,bgColor=0,sunColor=2236962,orbitRadius=20,postprocessing={enabled:!0};init(),animate();var info=document.getElementById("info"),action_vr=document.getElementById("vr_mode"),action_desktop=document.getElementById("desktop_mode"),action_rollercoaster=document.getElementById("rollercoaster"),action_rad=document.getElementById("ferris_wheel"),action_monster=document.getElementById("monster"),action_explore=document.getElementById("explore");info.addEventListener("mouseover",function(e){controls.enabled=!1}),info.addEventListener("mouseout",function(e){controls.enabled=!0}),action_rollercoaster.addEventListener("click",function(e){camera.position.set(0,0,0),å.track.enabled=!0,å.monster.enabled=!1,å.rad.enabled=!1,check_Camera(camera)}),action_monster.addEventListener("click",function(e){camera.position.set(0,0,0),å.track.enabled=!1,å.monster.enabled=!0,å.rad.enabled=!1,check_Camera(camera)}),action_rad.addEventListener("click",function(e){camera.position.set(0,0,0),å.track.enabled=!1,å.monster.enabled=!1,å.rad.enabled=!0,check_Camera(camera)}),action_explore.addEventListener("click",function(e){camera.position.set(0,0,0),å.track.enabled=!1,å.monster.enabled=!1,å.rad.enabled=!1,å.explore.enabled=!1,check_Camera(camera),camera.position.set(0,0,10),camera.lookAt(new THREE.Vector3(0,0,1)),å.mode.vr||(controls=orbit_controls(camera))}),action_desktop.addEventListener("click",function(e){å.mode.vr=!1,å.mode.desktop=!0,å.mode.orientation=!1,controls=orbit_controls(controls),onWindowResize(),controls.enabled=!0}),action_vr.addEventListener("click",function(e){å.mode.orientation=!0,controls=vr_controls(controls)}),window.addEventListener("resize",onWindowResize,!1);var current=0;