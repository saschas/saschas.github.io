function hashCode(e){return e.split("").reduce(function(e,a){return e=(e<<5)-e+a.charCodeAt(0),e&e},0)}function isInRange(e,a,t){return e>=a&&t>=e}function wrapTexture(e,a){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(a,a)}function loaderBar(e){var a=document.createElement("div");a.classList.add("loader");var t=document.createElement("div");t.classList.add("loadInner"),a.appendChild(t),e.appendChild(a),this.update=function(e){t.style.width=e+"%"},this.remove=function(){a.parentElement.removeChild(a)}}function createElement(e){var a=null,t=document.createElement(e.type);if(t.classList.add("element-"+e.type),"inputType"in e){a=document.createElement("div"),a.classList.add("element-holder-input"),t.type=e.inputType,t.name=e.classer,t.checked=e.checked,t.id=e.type+"-"+hashCode(e.content),a.appendChild(t);var r=document.createElement("label");r.innerHTML=e.content,r.setAttribute("for",t.id),a.appendChild(r)}else"content"in e&&(t.innerHTML=e.content);return"classer"in e&&t.classList.add(e.classer),"cb"in e&&t.addEventListener(e.cbType,function(a){e.cb(a)}),null!=a?a:t}function createSource(e){var a=audioContext.createBufferSource();return a.buffer=e,a.connect(audioContext.destination),{source:a}}function playSound(e,a){if(!gameOptions.mute){var t=createSource(e);return t.source.loop=a,t.playing=!0,t.source.start?t.source.start():t.source.noteOn(0),t}}function init(){function e(e,a){a[0]=new THREE.MeshStandardMaterial({color:11184810,map:concrete_tex,roughness:.7,metalness:.2,aoMapIntensity:2,bumpScale:.05,shading:THREE.FlatShading,aoMap:concrete_tex_aoMap,metalnessMap:concrete_tex_metalness,bumpMap:concrete_tex_norm}),floor=new THREE.Mesh(e,new THREE.MeshFaceMaterial(a)),floor.receiveShadow=!0,floor.castShadow=!0,scene.add(floor)}function a(e,a){a.forEach(function(e,a){console.log(e.name,a)}),a[0]=new THREE.MeshStandardMaterial({color:13421772,map:rohr_albedo,bumpScale:.1,roughness:.8,metalness:.7,metalnessMap:rohr_metallic,roughnessMap:rohr_roughness,bumpMap:rohr_normal}),a[1]=new THREE.MeshStandardMaterial({color:16777215,emissive:6710886}),a[2]=new THREE.MeshStandardMaterial({color:3355443});var t=new THREE.Mesh(e,new THREE.MeshFaceMaterial(a));t.castShadow=!0,scene.add(t)}function t(e,a){var t=new THREE.Mesh(e,new THREE.MeshBasicMaterial({map:texture,transparent:!0,alphaTest:.005,side:THREE.DoubleSide})),r={texture:{value:texture}},o=document.getElementById("vertexShaderDepth").textContent,n=document.getElementById("fragmentShaderDepth").textContent;t.customDepthMaterial=new THREE.ShaderMaterial({uniforms:r,vertexShader:o,fragmentShader:n,side:THREE.DoubleSide}),t.castShadow=!0,scene.add(t)}console.log("init"),scene=new THREE.Scene;var r=new THREE.PerspectiveCamera(55,canvas_width/canvas_height,.1,1e3);r.position.set(10,4,-3),scene.add(r),renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),renderer.setSize(canvas_width,canvas_height),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.setClearColor(main_color,1),renderer.domElement.classList.add("pongGame"),document.body.appendChild(renderer.domElement),window.onresize=function(){canvas_height=window.innerHeight,canvas_width=window.innerWidth,r.aspect=canvas_width/canvas_height,r.updateProjectionMatrix(),renderer.setSize(canvas_width,canvas_height)};var o=new THREE.RenderPass(scene,r),n=new THREE.BokehPass(scene,r,{focus:1,aperture:.15,maxblur:2,width:canvas_width,height:canvas_height});n.renderToScreen=!0;var s=new THREE.EffectComposer(renderer),l=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1,.05,.25),i=new THREE.MeshDepthMaterial;i.depthPacking=THREE.RGBADepthPacking,i.blending=THREE.NoBlending;var p={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter};depthRenderTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,p);var c=new THREE.ShaderPass(THREE.SSAOShader);c.renderToScreen=!1,c.uniforms.tDepth.value=depthRenderTarget.texture,c.uniforms.size.value.set(window.innerWidth,window.innerHeight),c.uniforms.cameraNear.value=r.near,c.uniforms.cameraFar.value=r.far,c.uniforms.onlyAO.value=1==postprocessing.renderMode,c.uniforms.aoClamp.value=.5,c.uniforms.lumInfluence.value=.05,s.addPass(o),s.addPass(c),s.addPass(l),s.addPass(n),postprocessing.composer=s,postprocessing.bokeh=n,controls=new THREE.OrbitControls(r),controls.target.set(0,4,-3),controls.damping=0,controls.noKeys=!0,controls.minPolarAngle=80*Math.PI/180,controls.maxPolarAngle=99*Math.PI/180,controls.minAzimuthAngle=60*Math.PI/180,controls.maxAzimuthAngle=120*Math.PI/180,controls.minDistance=10,controls.maxDistance=13;var d=new THREE.AmbientLight(10066329);scene.add(d);var y=100,u=new THREE.SpotLight(3846139);u.position.set(3,10,-5),u.intensity=.2,u.angle=Math.PI/3,u.penumbra=.9,u.castShadow=!0,u.shadow.mapSize.width=512,u.shadow.mapSize.height=512,u.shadow.camera.near=1,u.shadow.camera.far=30,u.shadow.camera.fov=r.fov,u.shadow.camera.left=-y,u.shadow.camera.right=y,u.shadow.camera.top=y,u.shadow.camera.bottom=-y,scene.add(u);var h=new THREE.SpotLight(16379852);h.position.set(-3.5,4,2.5),h.target.position.set(.5,0,2.5),h.target.updateMatrixWorld(),h.intensity=.4,h.angle=Math.PI/4,h.penumbra=.9,h.castShadow=!0,h.shadow.mapSize.width=512,h.shadow.mapSize.height=512,h.shadow.camera.near=1,h.shadow.camera.far=50,h.shadow.camera.fov=r.fov,h.shadow.camera.left=-y,h.shadow.camera.right=y,h.shadow.camera.top=y,h.shadow.camera.bottom=-y,scene.add(h);var m=new THREE.SpotLight(16379852);m.position.set(-3.5,4,-9.25),m.target.position.set(.5,0,-9.25),m.target.updateMatrixWorld(),m.intensity=.4,m.angle=Math.PI/4,m.penumbra=.9,m.castShadow=!0,m.shadow.mapSize.width=512,m.shadow.mapSize.height=512,m.shadow.camera.near=1,m.shadow.camera.far=50,m.shadow.camera.fov=r.fov,m.shadow.camera.left=-y,m.shadow.camera.right=y,m.shadow.camera.top=y,m.shadow.camera.bottom=-y,scene.add(m),wrapTexture(concrete_tex,8),wrapTexture(concrete_tex_norm,8),wrapTexture(concrete_tex_metalness,8),wrapTexture(concrete_tex_aoMap,8);wrapTexture(rohr_albedo,10),wrapTexture(rohr_metallic,10),wrapTexture(rohr_roughness,10),wrapTexture(rohr_normal,40),texture=new THREE.Texture(canvas),e(assets.floor.geometry,assets.floor.material),a(assets.rohr.geometry,assets.rohr.material),t(assets.screen.geometry,assets.screen.material),render(time)}function Explosion(e,a){this.count=50,this.isActive=!0,this.createPoints=function(t){for(var r=[],o=0;o<this.count;o++)r.push({pos:{x:e.x,y:e.y},vel:{x:-1.5+3*Math.random(),y:a+3*Math.random()},lifetime:0,maxLifetime:20+50*Math.random()});return r};var t=this.createPoints();this.update=function(e){var a=0;c.fillStyle="#ff9800",t.forEach(function(t,r){t.pos.x+=t.vel.x,t.pos.y+=t.vel.y,t.lifetime<t.maxLifetime?(e.fillRect(t.pos.x,t.pos.y,2,2),t.lifetime++):a++}),c.fillStyle="#2ca3ff",a==this.count&&(this.isActive=!1)}}function Bounce(e,a){this.count=5,this.isActive=!0,this.createRadius=function(a){for(var t=[],r=0;r<this.count;r++)t.push({pos:{x:e.x,y:e.y},rad:1,radVel:50*Math.random(),lifetime:0,maxLifetime:20+10*Math.random()});return t};var t=this.createRadius();this.update=function(e){var r=0;c.setLineDash([0,0]);var o={};a>0?(o.start=320,o.end=40):(o.start=130,o.end=230),t.forEach(function(t,o){t.rad+=.01*t.radVel,t.pos.x+=.25*a,t.lifetime<t.maxLifetime?(e.beginPath(),e.arc(t.pos.x,t.pos.y,t.rad,0,2*Math.PI,!1),e.lineWidth=1,e.stroke(),t.lifetime++):r++}),c.strokeStyle="#2ca3ff",c.setLineDash([15,15]),r==this.count&&(this.isActive=!1)}}function respawn(){ball.dir.x>0&&(player.a.points+=1,2==gameOptions.playerCount?playSound(assets.sounds.juchu,!1):playSound(assets.sounds.loose,!1)),ball.dir.x<0&&(player.b.points+=1,2==gameOptions.playerCount?playSound(assets.sounds.juchu,!1):playSound(assets.sounds.loose,!1)),ball.pos.x=screenSize.x/2,ball.pos.y=screenSize.y/2+Math.random()*screenSize.y/4,ball.vel.y=.5*Math.random(),(player.a.points>=10||player.b.points>=10)&&(gameOptions.playing=!0)}function handlePlayer(){keyCode.player1.left&&(player.b.vel.x-=.25),keyCode.player1.right&&(player.b.vel.x+=.25),keyCode.player1.up&&(player.b.vel.y-=1),keyCode.player1.down&&(player.b.vel.y+=1),keyCode.player2.left&&(player.a.vel.x-=.25),keyCode.player2.right&&(player.a.vel.x+=.25),keyCode.player2.up&&(player.a.vel.y-=1),keyCode.player2.down&&(player.a.vel.y+=1)}function handleKeyMap(){keyCode.player1.left=keyMap[37],keyCode.player1.right=keyMap[39],keyCode.player1.up=keyMap[38],keyCode.player1.down=keyMap[40],keyCode.player2.left=keyMap[65],keyCode.player2.right=keyMap[68],keyCode.player2.up=keyMap[87],keyCode.player2.down=keyMap[83],(keyMap[32]||keyMap[27])&&gameOptions.playing&&(gameOptions.playing=!gameOptions.playing,holder.classList.toggle("inGame"))}function animation(e){texture.needsUpdate=!0,player.a.bounce.multiplier*=.99,player.b.bounce.multiplier*=.99,player.a.vel.x*=.9,player.b.vel.x*=.9,player.a.vel.y*=.9,player.b.vel.y*=.9,c.update(e)}var main_color=0,time=0,canvas_height=window.innerHeight,canvas_width=window.innerWidth,floor,screenSize={x:1024,y:468},postprocessing={},scene,renderer,controls,texture,playBox,rePlayBox,explosions=[],bounces=[],assets={floor:{},rohr:{},screen:{},sounds:{}},gameOptions={playing:!1,audio:!1,playerCount:1,playSelect:!1,menuIndex:0,menuMax:2,alreadyPlayed:!1,mute:!1,loaded:!1},keyCode={player1:{up:!1,down:!1,left:!1,right:!1},player2:{up:!1,down:!1,left:!1,right:!1}},keyMap={37:!1,38:!1,39:!1,40:!1,65:!1,68:!1,83:!1,87:!1,32:!1,27:!1},menu={title:"PONG",playTitle:"PLAY"},player={a:{points:0,height:100,vel:{x:0,y:0},bounce:{x:0,y:0,multiplier:0},size:{x:5,y:100},pos:{x:10,y:screenSize.y/2}},b:{points:0,height:100,vel:{x:0,y:0},bounce:{x:0,y:0,multiplier:0},size:{x:5,y:100},pos:{x:screenSize.x-15,y:screenSize.y/2}}},ball={size:{x:10,y:10},pos:{x:screenSize.x/2,y:screenSize.y/2},spin:{x:0,y:0},vel:{x:1,y:1},dir:{x:1,y:1},speed:{x:5,y:5}},manager=new THREE.LoadingManager;manager.onProgress=function(e,a,t){loaderBarEl.update(a/t*100),a==t&&(gameOptions.loaded=!0,loaderBarEl.remove(),init())};var loader=new THREE.JSONLoader(manager),textureLoader=new THREE.TextureLoader(manager),canvas=document.createElement("canvas");canvas.width=1024,canvas.height=1024,canvas.classList.add("pong"),document.body.appendChild(canvas);var c=canvas.getContext("2d");c.fillStyle="#2ca3ff",c.strokeStyle="#2ca3ff",c.font="60px VT323";var holder=createElement({type:"div",classer:"holder"});holder.classList.add("start");var menuHolder=createElement({type:"div",classer:"menu-holder"});holder.appendChild(createElement({type:"h1",classer:"title",content:menu.title}));var playerForm=createElement({type:"form",classer:"choose-playerCount"});menuHolder.appendChild(playerForm),playerForm.appendChild(createElement({type:"input",inputType:"radio",classer:"button-player",content:"1 Player",checked:!0,cbType:"change",cb:function(){gameOptions.playerCount=1,console.log(gameOptions.playerCount)}})),playerForm.appendChild(createElement({type:"input",inputType:"radio",classer:"button-player",content:"2 Player",checked:!1,cbType:"change",cb:function(){gameOptions.playerCount=2,console.log(gameOptions.playerCount)}})),menuHolder.appendChild(createElement({type:"button",classer:"button-mute",cbType:"click",content:"mute",cb:function(e){gameOptions.mute=!gameOptions.mute,e.target.classList.toggle("selected")}})),menuHolder.appendChild(createElement({type:"button",classer:"button-restart",cbType:"click",content:"Restart",cb:function(e){respawn(),player.a.points=0,player.b.points=0,holder.classList.add("inGame"),gameOptions.playing=!0}}));var playerButton=createElement({type:"button",classer:"button-play",cbType:"click",content:"Play",cb:function(e){gameOptions.loaded&&(holder.classList.add("inGame"),holder.classList.remove("start"),holder.classList.add("playGame"),gameOptions.playing=!0)}});menuHolder.appendChild(playerButton);var loaderBarEl=new loaderBar(playerButton);menuHolder.appendChild(createElement({type:"button",classer:"button-continue",cbType:"click",content:"continue",cb:function(e){holder.classList.add("inGame"),gameOptions.playing=!0}})),holder.appendChild(menuHolder),document.body.appendChild(holder);var concrete_tex=textureLoader.load("assets/textures/concrete.jpg"),concrete_tex_norm=textureLoader.load("assets/textures/concrete_NRM.jpg"),concrete_tex_aoMap=textureLoader.load("assets/textures/concrete_OCC.jpg"),concrete_tex_metalness=textureLoader.load("assets/textures/concrete_SPEC.jpg"),rohr_albedo=textureLoader.load("assets/textures/rohr_albedo.jpg"),rohr_metallic=textureLoader.load("assets/textures/rohr_metallic.jpg"),rohr_roughness=textureLoader.load("assets/textures/rohr_roughness.jpg"),rohr_normal=textureLoader.load("assets/textures/rohr_normal.jpg");loader.load("assets/json/floor.json",function(e,a){assets.floor.geometry=e,assets.floor.material=a}),loader.load("assets/json/rohr.json",function(e,a){assets.rohr.geometry=e,assets.rohr.material=a}),loader.load("assets/json/screen.json",function(e,a){assets.screen.geometry=e,assets.screen.material=a});var bufferLoader;window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=new AudioContext,bufferLoader=new AudioBufferLoader(audioContext);bufferLoader.loadBuffer("dip","assets/sounds/blub.mp3",function(e){assets.sounds.dip=e}),bufferLoader.loadBuffer("blub","assets/sounds/dip3.mp3",function(e){assets.sounds.blub=e}),bufferLoader.loadBuffer("blub","assets/sounds/loose.mp3",function(e){assets.sounds.loose=e}),bufferLoader.loadBuffer("juchu","assets/sounds/juchu.mp3",function(e){assets.sounds.juchu=e}),c.update=function(e){if(this.clearRect(0,0,1024,1024),c.fillText(player.a.points,screenSize.x/4,50),c.fillText(player.b.points,screenSize.x/4*3,50),c.setLineDash([15,15]),c.beginPath(),c.lineWidth=2,c.moveTo(screenSize.x/2,0),c.lineTo(screenSize.x/2,screenSize.y),c.stroke(),gameOptions.playing&&(1==gameOptions.playerCount&&(player.a.pos.y<ball.pos.y?(player.a.pos.y+=4-3*Math.random(),player.a.vel.y+=.75):(player.a.pos.y-=4-3*Math.random(),player.a.vel.y-=.75)),player.a.pos.y+=player.a.vel.y,player.b.pos.y+=player.b.vel.y,player.a.pos.x+=player.a.vel.x,player.b.pos.x+=player.b.vel.x,ball.pos.x+=ball.vel.x*ball.speed.x*ball.dir.x,ball.pos.y+=ball.vel.y*ball.speed.y*ball.dir.y),player.a.pos.x=player.a.pos.x<=0?0:player.a.pos.x,player.a.pos.x=player.a.pos.x>=screenSize.x/2?screenSize.x/2:player.a.pos.x,player.b.pos.x=player.b.pos.x<=screenSize.x/2+player.b.size.x?screenSize.x/2+player.b.size.x:player.b.pos.x,player.b.pos.x=player.b.pos.x>=screenSize.x-player.b.size.x?screenSize.x-player.b.size.x:player.b.pos.x,player.a.pos.y=player.a.pos.y<=player.a.height/2?player.a.height/2:player.a.pos.y,player.a.pos.y=player.a.pos.y>=screenSize.y-player.a.height/2?screenSize.y-player.a.height/2:player.a.pos.y,player.b.pos.y=player.b.pos.y<=player.b.height/2?player.b.height/2:player.b.pos.y,player.b.pos.y=player.b.pos.y>=screenSize.y-player.b.height/2?screenSize.y-player.b.height/2:player.b.pos.y,player.a.bounce.x=Math.sin(.05*e)*player.a.bounce.multiplier,player.b.bounce.x=Math.sin(.05*e)*player.b.bounce.multiplier,c.setLineDash([]),c.lineWidth=5,c.beginPath(),c.moveTo(player.a.pos.x,player.a.pos.y-player.a.height/2),c.bezierCurveTo(player.a.pos.x+player.a.bounce.x,player.a.pos.y-player.a.height/4,player.a.pos.x+player.a.bounce.x,player.a.pos.y+player.a.height/4,player.a.pos.x,player.a.pos.y+player.a.height/2),c.stroke(),c.setLineDash([]),c.lineWidth=5,c.beginPath(),c.moveTo(player.b.pos.x,player.b.pos.y-player.b.height/2),c.bezierCurveTo(player.b.pos.x+player.b.bounce.x,player.b.pos.y-player.b.height/4,player.b.pos.x+player.b.bounce.x,player.b.pos.y+player.b.height/4,player.b.pos.x,player.b.pos.y+player.b.height/2),c.stroke(),isInRange(ball.pos.y,player.b.pos.y-player.b.size.y/2,player.b.pos.y+player.b.size.y/2)&&isInRange(ball.pos.x+ball.size.x/2,player.b.pos.x,player.b.pos.x+player.b.size.x)&&(playSound(assets.sounds.blub,!1),player.b.bounce.multiplier=5,ball.dir.x*=-1,bounces.push(new Bounce({x:ball.pos.x,y:ball.pos.y},-1))),isInRange(ball.pos.y,player.a.pos.y-player.a.size.y/2,player.a.pos.y+player.a.size.y/2)&&isInRange(ball.pos.x-ball.size.x/2,player.a.pos.x,player.a.pos.x+player.a.size.x)&&(playSound(assets.sounds.blub,!1),player.a.bounce.multiplier=5,ball.dir.x*=-1,ball.vel.y-=.075*player.a.vel.y,bounces.push(new Bounce({x:ball.pos.x,y:ball.pos.y},1))),(ball.pos.x<ball.size.x/2||ball.pos.x>screenSize.x-ball.size.x/2)&&respawn(),ball.pos.y>=screenSize.y||ball.pos.y<=0){ball.dir.y*=-1;var a=null;a=ball.pos.y>screenSize.y/2?-1:1,playSound(assets.sounds.dip,!1),explosions.push(new Explosion({x:ball.pos.x,y:ball.pos.y},a))}c.fillRect(ball.pos.x-ball.size.x/2,ball.pos.y-ball.size.y/2,10,10),explosions.forEach(function(e,a){e.isActive?e.update(c):explosions.splice(a,1)}),bounces.forEach(function(e,a){e.isActive?e.update(c):bounces.splice(a,1)})},window.addEventListener("keydown",function(e){keyMap[e.keyCode]=!0}),window.addEventListener("keyup",function(e){keyMap[e.keyCode]=!1});var render=function(e){requestAnimationFrame(render),animation(e),controls.update(),handleKeyMap(),handlePlayer(),postprocessing.composer.render(.1)};