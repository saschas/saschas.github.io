function randNum(e,t,n){var a=Math.floor(Math.random()*t)+e;return(n||"undefined"==typeof n)&&(a*=1==Math.floor(2*Math.random())?1:-1),a}function createButterFly(){var e=new THREE.Object3D;this.count=0;var t=this;return tex_loader.load(opt.urls.tex.butterfly.left,function(n){var a=new THREE.MeshPhongMaterial({color:16777215,map:n,transparent:!0,depthTest:!0,depthWrite:!0,alphaTest:.8,side:THREE.DoubleSide}),o=new THREE.PlaneGeometry(1,1,1,1);o.vertices.forEach(function(e,t){e.x-=.5});var r=new THREE.Mesh(o,a);r.update=function(e){this.rotation.y=Math.sin(.025*e)},e.add(r),t.count++}),tex_loader.load(opt.urls.tex.butterfly.right,function(n){var a=new THREE.MeshPhongMaterial({color:16777215,map:n,transparent:!0,depthTest:!0,depthWrite:!0,alphaTest:.9,side:THREE.DoubleSide}),o=new THREE.PlaneGeometry(1,1,1,1);o.vertices.forEach(function(e,t){e.x+=.5});var r=new THREE.Mesh(o,a);r.update=function(e){this.rotation.y=Math.sin(-.025*e)},e.add(r),t.count++}),e.castShadow=!0,e.rotation.x=-90*Math.PI/180,e.rotation.z=90*Math.PI/180,e.update=function(e){this.position.x=20*Math.sin(2e-4*e),this.position.z=20*Math.cos(-2e-4*e),this.position.y=10+5*Math.sin(-2e-4*e),this.rotation.z=-(2*Math.PI/20*360/e*-2e-4)*Math.PI/180,this.children.forEach(function(t,n){t.update(e)})},e}function animation(e){schwarm.length>0&&schwarm.forEach(function(t,n){t.update(e)}),null!=opt.mod.schaukel&&opt.mod.schaukel.update(e),null!=opt.mod.man&&opt.mod.man.update(e),null!=opt.mod.sun&&opt.mod.sun.update(e);var t=.75*clock.getDelta();THREE.AnimationHandler.update(t),void 0!==helper&&helper.update()}var main_color=16777215,canvas_height=window.innerHeight,canvas_width=window.innerWidth,clock=new THREE.Clock,time=0,opt={textures:{tree:null,gras:null,stones:null},mod:{schaukel:null,gras:null,sun:null,man:null,groundPlane:null},urls:{tex:{clouds:"assets/textures/clouds.png",sun:"assets/textures/sun.png",schaukel:"assets/textures/schaukel.jpg",stones:"assets/textures/stones.jpg",man:"assets/textures/man.jpg",tree:"assets/textures/tree.jpg",gras:"assets/textures/gras.jpg",butterfly:{left:"assets/textures/butterfly_left.png",right:"assets/textures/butterfly_right.png"}},model:{man:"assets/json/man.json",stones:"assets/json/stones.json",tree:"assets/json/tree.json"}}},cloud_origin={x:0,y:0,z:0},scene=new THREE.Scene,sunScene=new THREE.Scene;scene.fog=new THREE.Fog(15841862,1,1e4);var camera=new THREE.PerspectiveCamera(65,canvas_width/canvas_height,.1,1e3),sunCamera=new THREE.PerspectiveCamera(65,canvas_width/canvas_height,.1,1e3);camera.position.set(-16,6.8,-19.85),scene.add(camera),sunScene.add(sunCamera);var renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),sunRenderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0});renderer.setSize(canvas_width,canvas_height),sunRenderer.setSize(canvas_width,canvas_height),renderer.domElement.className+="renderer",sunRenderer.domElement.className+="sunRenderer",renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.body.appendChild(sunRenderer.domElement),document.body.appendChild(renderer.domElement);var composer=new THREE.EffectComposer(renderer);composer.addPass(new THREE.RenderPass(scene,camera));var depthShader=THREE.ShaderLib.depthRGBA,depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms),depthMaterial=new THREE.ShaderMaterial,depthTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat});composer.setSize(window.innerWidth,window.innerHeight);var effectOutline=new THREE.ShaderPass({uniforms:{tDiffuse:{type:"t",value:0,texture:null},uScreenWidth:{type:"f",value:window.innerWidth},uScreenHeight:{type:"f",value:window.innerHeight}},vertexShader:document.getElementById("outline-vertex").textContent,fragmentShader:document.getElementById("outline-frag").textContent});effectOutline.renderToScreen=!0,composer.addPass(effectOutline),window.onresize=function(){canvas_height=window.innerHeight,canvas_width=window.innerWidth,camera.aspect=canvas_width/canvas_height,camera.updateProjectionMatrix(),renderer.setSize(canvas_width,canvas_height),sunRenderer.setSize(canvas_width,canvas_height)},controls=new THREE.OrbitControls(camera),controls.target=new THREE.Vector3(-8,7.5,-1.5),controls.damping=.2,controls.maxPolarAngle=110*Math.PI/180,controls.minDistance=20,controls.maxDistance=30,controls.update();var ambient=new THREE.AmbientLight(10066329,1);scene.add(ambient);var spotLight=new THREE.SpotLight(16764782);spotLight.position.set(0,100,150),spotLight.intensity=2,spotLight.castShadow=!0,spotLight.shadowMapWidth=1024,spotLight.shadowMapHeight=1024,scene.add(spotLight);var backLight=new THREE.SpotLight(11785693,.5);backLight.position.z=-200,scene.add(backLight);var loader=new THREE.JSONLoader,tex_loader=new THREE.TextureLoader;tex_loader.load(opt.urls.tex.tree,function(e){opt.textures.tree[0].color=new THREE.Color(16777215),opt.textures.tree[0].map=e,opt.textures.tree[0].bumpMap=e,opt.textures.tree[0].side=THREE.DoubleSide,opt.textures.tree[0].needsUpdate=!0}),loader.load(opt.urls.model.tree,function(e,t){t[0].side=THREE.DoubleSide,opt.textures.tree=t;var n=new THREE.Mesh(e,new THREE.MeshFaceMaterial(opt.textures.tree));n.castShadow=!0,n.receiveShadow=!0,scene.add(n)});var schwarm=[];schwarm.push(createButterFly()),schwarm.forEach(function(e,t){scene.add(e)}),tex_loader.load(opt.urls.tex.stones,function(e){opt.textures.stones=e,loader.load(opt.urls.model.stones,function(e,t){var n=new THREE.Mesh(e,new THREE.MeshFaceMaterial(t));console.log(opt.textures.stones,t,n),n.material.materials[0].color=new THREE.Color(16777215),n.material.materials[0].map=opt.textures.stones,n.material.materials[0].bumpMap=opt.textures.stones,n.material.materials[0].side=THREE.DoubleSide,n.material.materials[0].needsUpdate=!0;for(var a=new THREE.Group,o=0,r=0;r<opt.mod.groundPlane.geometry.vertices.length;r++)if(r%8==0&&opt.mod.groundPlane.geometry.vertices[r].z>1){a.children[o]=n.clone();var s=randNum(.28,.5,!1);a.children[o].scale.set(s,s,s),a.children[o].position.x=opt.mod.groundPlane.geometry.vertices[r].x+randNum(0,5,!1),a.children[o].position.y=1.2-opt.mod.groundPlane.geometry.vertices[r].z,a.children[o].position.z=opt.mod.groundPlane.geometry.vertices[r].y+randNum(0,2,!1),a.children[o].rotation.y=randNum(0,360,!1),o++}scene.add(a)})});var helper,skel_animation;tex_loader.load(opt.urls.tex.schaukel,function(e){opt.textures.schaukel=e,tex_loader.load(opt.urls.tex.man,function(e){opt.textures.man=e,loader.load(opt.urls.model.man,function(e,t){console.log(t),t[0].skinning=!0,t[0].map=opt.textures.schaukel,t[0].shading=THREE.FlatShading,t[0].color=new THREE.Color(16777215),t[1].specular=new THREE.Color(3355443),t[1].skinning=!0,t[1].map=opt.textures.man,t[1].shading=THREE.FlatShading,t[1].color=new THREE.Color(16777215),t[1].specular=new THREE.Color(3355443),opt.mod.man=new THREE.SkinnedMesh(e,new THREE.MeshFaceMaterial(t)),console.log(opt.mod.man.geometry,opt.mod.man),opt.mod.man.position.set(-9.5,12.65,-.15),opt.mod.man.castShadow=!0,opt.mod.man.update=function(e){this.rotation.x=.25*Math.sin(.002*e)},skel_animation=new THREE.Animation(opt.mod.man,e.animations[1]),skel_animation.interpolationType=THREE.AnimationHandler.CATMULLROM_FORWARD,skel_animation.play(),skel_animation.timeScale=1,helper=new THREE.SkeletonHelper(opt.mod.man),helper.material.linewidth=1,helper.visible=!1,scene.add(helper),scene.add(opt.mod.man)})})}),tex_loader.load(opt.urls.tex.sun,function(e){var t=new THREE.PlaneGeometry(100,100);opt.mod.sun=new THREE.Mesh(t,new THREE.MeshBasicMaterial({map:e,color:new THREE.Color(16777215),blending:THREE.AdditiveAlphaBlending,transparent:!0,sizeAttenuation:!0,transparent:!0,depthTest:!0,depthWrite:!0,alphaTest:.05,fog:!1,side:THREE.DoubleSide})),opt.mod.sun.position.z+=200,opt.mod.sun.position.y+=10,opt.mod.sun.update=function(e){this.rotation.copy(camera.rotation)},sunScene.add(opt.mod.sun)}),tex_loader.load(opt.urls.tex.clouds,function(e){for(var t=new THREE.PointsMaterial({color:new THREE.Color(16777215),size:150,sizeAttenuation:!0,transparent:!0,depthTest:!0,depthWrite:!0,blending:THREE.AdditiveAlphaBlending,alphaTest:.8,map:e,fog:!1}),n=new THREE.Geometry,a=0;50>a;a++){var o=randNum(50,200,!0),r=randNum(50,200,!1),s=randNum(50,200,!0);n.vertices.push(new THREE.Vector3(o,r,s))}var i=new THREE.Points(n,t);sunScene.add(i)}),tex_loader.load(opt.urls.tex.gras,function(e){var t=new THREE.PlaneGeometry(100,100,64,64);opt.textures.gras=e,opt.textures.gras.wrapS=opt.textures.gras.wrapT=THREE.Repeat,opt.textures.gras.repeat=new THREE.Vector2(10,10);var n=new THREE.MeshPhongMaterial({color:5007649,side:THREE.DoubleSide,shading:THREE.FlatShading,shininess:1,specular:new THREE.Color(10976881),vertexColors:THREE.VertexColors,map:e,bumpMap:opt.textures.gras,bumpScale:.2}),a=[];opt.mod.groundPlane=new THREE.Mesh(t,n),opt.mod.groundPlane.rotation.x=90*Math.PI/180,opt.mod.groundPlane.geometry.vertices.forEach(function(e,t){e.z+=.5-(Math.random()*(.04*(e.x+e.y))-randNum(0,1.05,!1))+.05*(Math.abs(e.x)+Math.abs(e.y)),a.push(new THREE.Color(0)),(e.y>49||e.y<-49||e.x<-49||e.x>49)&&(e.z=20)}),opt.mod.groundPlane.position.y+=1,opt.mod.groundPlane.geometry.colors=a,opt.mod.groundPlane.geometry.colorsNeedUpdate=!0,opt.mod.groundPlane.receiveShadow=!0,opt.mod.groundPlane.geometry.verticesNeedsUpdate=!0,scene.add(opt.mod.groundPlane)});var render=function(e){animation(e),controls.update(),renderer.clear(),composer.render(),sunCamera.position.copy(camera.position),sunCamera.rotation.copy(camera.rotation),sunRenderer.render(sunScene,sunCamera),requestAnimationFrame(render)};render(time);