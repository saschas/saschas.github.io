function calculatePointInCircle(e){return x=2*Math.random()*e-e,zlim=Math.sqrt(e*e-x*x),z=2*Math.random()*zlim-zlim,[x,z]}function randNum(e,n,o){var t=Math.random()*n+e;return(o||"undefined"==typeof o)&&(t*=1==Math.floor(2*Math.random())?1:-1),t}function evaluateInput(e){return""!=e?!0:void document.body.classList.add("error")}function encoder(e){return encodeURIComponent(e)}function getSpacePosFromMouse(e,n){var o=new THREE.Vector3;o.set(e/window.innerWidth*2-1,2*-(n/window.innerHeight)+1,.5),o.unproject(camera);var t=o.sub(camera.position).normalize(),a=-camera.position.z/t.z,r=camera.position.clone().add(t.multiplyScalar(a));return r}function colorUpdate(e){"undefined"!=typeof flower&&(flowerColor=e,flower.material.materials[1].color=new THREE.Color("#"+flowerColor))}function animation(e){var n=.75*clock.getDelta();"undefined"!=typeof hearts&&hearts.children.forEach(function(n,o){n.update(e)}),flower.update(e),THREE.AnimationHandler.update(n/interpolation)}var urls={gras:"assets/json/gras.json",hearts:"assets/json/heart.json",flower:"assets/json/flower.json",flowerTexture:"assets/textures/flower.png"},urlParam=function e(){for(var e={},n=window.location.search.substring(1),o=n.split("&"),t=0;t<o.length;t++){var a=o[t].split("=");if("undefined"==typeof e[a[0]])e[a[0]]=decodeURIComponent(a[1]);else if("string"==typeof e[a[0]]){var r=[e[a[0]],decodeURIComponent(a[1])];e[a[0]]=r}else e[a[0]].push(decodeURIComponent(a[1]))}return e}(),flowerColor,floweranimation,hearts,clock=new THREE.Clock,time=0,duration=3,keyframes=3,interpolation=duration/keyframes,tween,origin={x:0,y:0,z:0},main_color=16777215,canvas_height=window.innerHeight,canvas_width=window.innerWidth,flower,card=document.getElementById("greeting_send"),colorChanger=document.getElementById("colorRange"),name_from=document.getElementById("name_from"),name_to=document.getElementById("name_to"),send=document.getElementById("send"),toName=document.getElementById("toName"),fromName=document.getElementById("fromName"),textureLoader=new THREE.TextureLoader,loader=new THREE.JSONLoader,scene=new THREE.Scene;if(scene.fog=new THREE.Fog(16375789,10,90),"fromName"in urlParam&&"toName"in urlParam&&"flowerColor"in urlParam){document.body.className+="receive",toName.innerHTML=urlParam.toName,fromName.innerHTML=urlParam.fromName,flowerColor=urlParam.flowerColor;var long_url=window.location.href;long_url=long_url.split("?");var title=document.getElementsByTagName("title");title[0].innerHTML="A flower for "+urlParam.fromName+" from "+urlParam.toName,send_own_message.setAttribute("href",long_url[0])}else document.body.className+="send",flowerColor="ffffff";colorChanger.addEventListener("change",function(){colorUpdate(this.jscolor)});var camera=new THREE.PerspectiveCamera(55,canvas_width/canvas_height,.1,1e3);camera.position.set(25,12,14),scene.add(camera);var renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0,transparent:!0});renderer.setSize(canvas_width,canvas_height),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,document.body.appendChild(renderer.domElement),window.onresize=function(){canvas_height=window.innerHeight,canvas_width=window.innerWidth,camera.aspect=canvas_width/canvas_height,camera.updateProjectionMatrix(),renderer.setSize(canvas_width,canvas_height)},controls=new THREE.OrbitControls(camera),controls.damping=.2,controls.target=new THREE.Vector3(0,12.5,0),controls.maxPolarAngle=Math.PI/2,controls.minPolarAngle=50*Math.PI/180,controls.minDistance=15,controls.maxDistance=30;var ambient=new THREE.AmbientLight(6710886,1);scene.add(ambient);var spotLight=new THREE.SpotLight(16777215);spotLight.position.set(0,500,500),spotLight.intensity=1,spotLight.castShadow=!0,spotLight.shadowCameraNear=10,spotLight.shadowCameraFar=1500,spotLight.shadowBias=1e-4,spotLight.shadowDarkness=.8,spotLight.shadowMapWidth=1024,spotLight.shadowMapHeight=1024,scene.add(spotLight),textureLoader.load(urls.flowerTexture,function(e){function n(n,o){return console.log(flowerColor),n.forEach(function(n,t){n.color=new THREE.Color(16777215),n.specular=new THREE.Color(16646091),n.shininess=.01,n.map=e,n.side=THREE.DoubleSide,n.bumpMap=e,n.bumpScale=.2,n.needsUpdate=!0,n.transparent=!0,n.depthTest=!0,n.depthWrite=!0,n.alphaTest=.35,o&&(n.morphTargets=!0,n.skinning=!0)}),n}loader.load(urls.flower,function(e,o){o=n(o,!0),o[1].color=new THREE.Color("#"+flowerColor),o[1].color=new THREE.Color("#"+flowerColor),o[1].alphaTest=.8;var t=new THREE.MeshFaceMaterial(o);flower=new THREE.SkinnedMesh(e,t),flower.castShadow=!0,floweranimation=new THREE.MorphAnimation(flower),scene.add(flower),flower.morphTargetInfluences[1]=.9,flower.scale.set(0,0,0),flower.update=function(e){this.skeleton.bones[4].rotation._x+=.25*(camera.rotation._x-this.skeleton.bones[4].rotation._x),this.skeleton.bones[4].rotation._y+=.25*(camera.rotation._y-this.skeleton.bones[4].rotation._y),this.skeleton.bones[4].rotation._z+=.25*(camera.rotation._z-this.skeleton.bones[4].rotation._z),this.skeleton.bones[4].rotation.x=this.skeleton.bones[4].rotation._x,this.skeleton.bones[4].rotation.y=this.skeleton.bones[4].rotation._y,this.skeleton.bones[4].rotation.z=this.skeleton.bones[4].rotation._z},grow=new TWEEN.Tween({x:0}).to({x:1},1500).easing(TWEEN.Easing.Quadratic.In).onUpdate(function(){flower.scale.set(this.x,this.x,this.x)}).onComplete(function(){document.body.className+=" halm"}),tween=new TWEEN.Tween({x:.9}).to({x:0},1500).easing(TWEEN.Easing.Bounce.Out).onUpdate(function(){flower.morphTargetInfluences[1]=this.x}).onComplete(function(){document.body.className+=" complete"}),grow.chain(tween),grow.start(),render(time)}),loader.load(urls.hearts,function(e,n){n[0].shininess=1,n[0].color=new THREE.Color(16208924),n[0].specular=new THREE.Color(15567721),n[0].opacity=.5,n[0].transparent=!0,n[0].blending=THREE.AdaptiveBlending,hearts=new THREE.Group;var o=new THREE.MeshFaceMaterial(n),t=new THREE.Mesh(e,o);hearts.add(t);for(var a=0;50>a;a++){hearts.children[a]=new THREE.Mesh(e,o),hearts.children[a]._own={indexer:0,max:50*Math.random()+150,random:{x:randNum(.01,.05,!0),y:randNum(.01,.05,!1),z:randNum(.01,.05,!0)},last:{x:0,y:0,z:0}},hearts.children[a].rotation.x=randNum(0,10,!0)*Math.PI/180,hearts.children[a].rotation.y=randNum(0,360,!0)*Math.PI/180,hearts.children[a].rotation.z=randNum(0,10,!0)*Math.PI/180;var r=randNum(.9,1.1,!1);hearts.children[a].update=function(e){var n=Math.max(100*this._own.indexer/this._own.max*.01,.01);this.scale.set(n,n,n),this.rotateY(.01),0==this._own.indexer?(this._own.last.x=origin.x,this._own.last.y=origin.y,this._own.last.z=origin.z):(this._own.last.x+=this._own.random.x,this._own.last.y+=this._own.random.y,this._own.last.z+=this._own.random.z),this.position.set(this._own.last.x,this._own.last.y,this._own.last.z),this._own.indexer<=this._own.max?this._own.indexer++:this._own.indexer=0}}scene.add(hearts)}),loader.load(urls.gras,function(e,o){for(var t=new THREE.MeshFaceMaterial(n(o,!1)),a,r=0;50>r;r++){var i=new THREE.Mesh(e,t);a=calculatePointInCircle(12),i.position.x=a[0],i.position.z=a[1],i.rotation.y=randNum(0,360,!1)*Math.PI/180,i.updateMatrix(),i.matrixAutoUpdate=!1,i.receiveShadow=!0,scene.add(i)}})});var planeMat=new THREE.MeshPhongMaterial({color:4542505,specular:0,shininess:0,side:THREE.DoubleSide}),radius=21,segments=32,circleGeometry=new THREE.RingGeometry(0,radius,segments,segments,0,2*Math.PI),ground=new THREE.Mesh(circleGeometry,planeMat);ground.rotation.x=90*Math.PI/180,ground.receiveShadow=!0,scene.add(ground);var boundMat=new THREE.MeshPhongMaterial({color:16777215,specular:15658734,shininess:0,side:THREE.DoubleSide,shading:THREE.FlatShading}),boundGeometry=new THREE.TorusGeometry(21.5,4,8,180),bound=new THREE.Mesh(boundGeometry,boundMat);bound.rotation.x=90*Math.PI/180,scene.add(bound);for(var particles=new THREE.Geometry,pMaterial=new THREE.PointsMaterial({color:16777215,size:.1,sizeAttenuation:!1,transparent:!0,opacity:.25}),i=0;1e4>i;i++){var x=40*(Math.random()-.5),y=40*(Math.random()-.5),z=40*(Math.random()-.5);particles.vertices.push(new THREE.Vector3(x,y,z))}var particleSystem_1=new THREE.Points(particles,pMaterial);scene.add(particleSystem_1);var render=function(e){requestAnimationFrame(render),animation(e),controls.update(),TWEEN.update(e),renderer.render(scene,camera)};document.body.addEventListener("mousemove",function(e){var n=getSpacePosFromMouse(e.pageX,e.pageY);origin.x=n.x,origin.y=n.y,origin.z=n.z}),card.addEventListener("mouseenter",function(){controls.enabled=!1}),card.addEventListener("mouseleave",function(){controls.enabled=!0}),send.addEventListener("click",function(e){e.preventDefault(e);var n=name_from.value,o=name_to.value;if(evaluateInput(n)&&evaluateInput(o)){document.body.classList.remove("error");var t=window.location+"?&fromName="+encoder(n)+"&toName="+encoder(o)+"&flowerColor="+encoder(flowerColor);send.setAttribute("aria-label",t),new Clipboard("#send",{text:function(e){return document.body.className+=" linkCopied",e.getAttribute("aria-label")}})}});