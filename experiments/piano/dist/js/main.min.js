function Player(e,a){var o=e.slice(0),t=this,n=[];this.play=!0,this.playNote=function(e){setTimeout(function(){t.play||(e=[]),n.forEach(function(e,a){e.rotation.x=0*Math.PI/180,n.splice(a,1)}),e.length>0?("__"!=e[0]&&e[0].forEach(function(e){var o=a?0:3;if(e.indexOf("-")>-1){e=e.replace("-","");var t=parseInt(e.match(/\d+/),10);o=o-t-t}var t=parseInt(e.match(/\d+/),10),s=e.toLowerCase().replace(t,t+o);pianoNotes[s].rotation.x=4*Math.PI/180,n.push(pianoNotes[s]),playSound(sounds[s].buffer,!1)}),e.shift(),t.playNote(e)):(pianoNotes.isPlaying=!1,n.forEach(function(e,a){e.rotation.x=0*Math.PI/180,n.splice(a,1)}))},250)},this.stopMusic=function(){this.play=!1,document.body.classList.add("paused")},this.playNote(o)}function over(e,a){}function out(e,a){e.rotation.x=0*Math.PI/180}function activeState(e,a){e.rotation.x=3*Math.PI/180,playSound(sounds[e._own.note].buffer,!1),pianoNotes.recording&&playBoard.push([e._own.note]),console.log(e._own)}function createShape(e,a,o,t,n){var s=null,r=null;switch(t.shape){case 0:s="w_l";break;case 1:s="w_r_l";break;case 2:s="w_r";break;case 3:s="b"}switch(t.color){case"w":r=white_material;break;case"b":r=black_material}pianoNotes[e+a]=pianoNotes[e+a]=new THREE.Mesh(assets.shapes[s],r),pianoNotes[e+a]._own={note:e+a,oct:a,index:o},pianoNotes[e+a].receiveShadow=!0,pianoNotes[e+a].castShadow=!0,pianoNotes[e+a].position.set(n.x,n.y,n.z),Adjust.addActiveObject(pianoNotes[e+a],over,out,activeState,!1),scene.add(pianoNotes[e+a]),Object.keys(pianoNotes).length==maxNotes&&(pianoNotes.ready=!0,document.body.classList.remove("loading"))}function loadSingleBuffer(e,a,o,t,n){bufferLoader.loadBuffer(o+e,basepath+t.sound+e+".mp3",function(s){sounds[o+e]={},sounds[o+e].buffer=s,createShape(o,e,a,t,n)})}function createSource(e){var a=audioContext.createBufferSource();return a.buffer=e,a.connect(audioContext.destination),{source:a}}function playSound(e,a){var o=createSource(e);return o.source.loop=a,o.playing=!0,o.source.start?o.source.start():o.source.noteOn(0),o}function prepareTexture(e,a){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(a,a)}function init(){function e(e,a){var o=new THREE.Mesh(e,new THREE.MeshStandardMaterial({color:0,metalness:.8,roughness:.005,side:THREE.DoubleSide,envMap:cubeCamera.renderTarget.texture,envMapIntensity:.15}));o.castShadow=!0,o.receiveShadow=!0,scene.add(o)}scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(55,canvas_width/canvas_height,.1,1e4),camera.position.set(25,12,16),scene.add(camera),cubeCamera=new THREE.CubeCamera(1,100,128),cubeCamera.position.set(0,12,0),scene.add(cubeCamera),renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),renderer.setSize(canvas_width,canvas_height),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.setClearColor(main_color,1),document.body.appendChild(renderer.domElement),Adjust.init({camera:camera,scene:scene,renderer:renderer}),controls=new THREE.OrbitControls(camera),controls.target.set(20,5,-2),controls.enabled=!0,controls.damping=.2,controls.maxPolarAngle=Math.PI/2,controls.minDistance=10,controls.maxDistance=220;var a=new THREE.PointLight(16777215,.5);a.position.set(0,80,50),scene.add(a);var o=new THREE.AmbientLight(11184810);scene.add(o),spotLight=new THREE.SpotLight(16777215),spotLight.position.set(-100,100,100),spotLight.castShadow=!0,spotLight.intensity=1,spotLight.penumbra=.9,spotLight.castShadow=!0;var t=50;spotLight.shadow.mapSize.width=1024,spotLight.shadow.mapSize.height=1024,spotLight.shadow.camera.near=1,spotLight.shadow.camera.far=800,spotLight.shadow.camera.left=-t,spotLight.shadow.camera.right=t,spotLight.shadow.camera.top=t,spotLight.shadow.camera.bottom=-t,scene.add(spotLight);var n=new THREE.Mesh(assets.geometry.sky,new THREE.MeshBasicMaterial({map:assets.texture.sky}));n.scale.set(5,5,5),scene.add(n),e(assets.geometry.piano,assets.materials.piano),white_material=new THREE.MeshStandardMaterial({color:16777215,envMap:cubeCamera.renderTarget.texture,envMapIntensity:.5,metalness:.1,roughness:.1}),black_material=new THREE.MeshStandardMaterial({color:2236962,envMap:cubeCamera.renderTarget.texture,envMapIntensity:.5,metalness:1,roughness:.1});for(var s=0,r="w",i=1,c=1;7>=c;c++){i=1;for(sound in sounds)s+="w"==sounds[sound].color&&"b"!=r?.65:.325,loadSingleBuffer(c,i,sound,sounds[sound],{x:s,y:0,z:0}),r=sounds[sound].color,"w"==sounds[sound].color&&i++}createRecordBar(),prepareTexture(assets.texture.ground_albedo,10),prepareTexture(assets.texture.ground_normal,10),prepareTexture(assets.texture.ground_heightmap,10);var d=new THREE.Mesh(new THREE.PlaneGeometry(600,600,128,128),new THREE.MeshStandardMaterial({color:11184810,map:assets.texture.ground_albedo,bumpMap:assets.texture.ground_normal,displacementMap:assets.texture.ground_heightmap,roughness:.9,metalness:0}));d.rotation.x=-90*Math.PI/180,d.position.y=-17,d.receiveShadow=!0,scene.add(d),render(time)}function createRecordBar(){var e=null,a=document.createElement("nav");a.classList.add("recordBar"),document.body.appendChild(a);var o=document.createElement("button");o.classList.add("play-button"),o.innerHTML="play",o.addEventListener("click",function(){pianoNotes.ready&&(a.classList.toggle("isPlaying"),document.body.classList.remove("paused"),pianoNotes.isPlaying?e.stopMusic():(e=0!=playBoard.length?new Player(playBoard,!0):new Player(musicData,!1),pianoNotes.isPlaying=!0))}),a.appendChild(o);var t=document.createElement("button");t.classList.add("record-button"),t.innerHTML="record",t.addEventListener("click",function(){a.classList.toggle("recording"),pianoNotes.recording=!pianoNotes.recording}),a.appendChild(t),pianoNotes.playButton=o,pianoNotes.nav=a}function animation(e){}var musicData=[["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["b1"],["a0"],["e1"],["b1"],["e1"],["a0"],["e1"],["b1"],["a0"],["e1"],["b1"],["a0"],["e1"],["b1"],["b0"],["c1"],["e1"],["g1"],["b1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["b1"],["e1"],["g0"],["e1"],["a1"],["b0"],["e1"],["a1"],["g0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["b1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["a0"],["e1"],["b1"],["d0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["a-1"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["f-1","a1"],["c0"],["a0"],["c0","e1"],["a0"],["c0"],["a0"],["c0"],["g-1"],["d0"],["b0"],["d0","b1"],["b0","a1"],["d0","b1"],["b0","a1"],["d0","b1"],["b0","a1"],["d0","b1"],["a-1"],["e0","a1"],["c0"],["e-1","e0"],["c0"],["e-1"],["c0"],["e-1"],["c0"],["b1"],["a1"],["b1"],["a1"],["b1"],["f-1","a1"],["c0"],["a0"],["c0","e1"],["a0"],["c0"],["a0"],["c0"],["g-1"],["d0"],["b0"],["d0","b1"],["b0","b1"],["d0","b1"],["b0","b1"],["d0","b1"],["a0","b1"],["e0","a1"],["a0"],["e0","e1"],["a0"],["e0"],["a0"],["e0"],["a0"],["b0"],["c1"],["e1"],["g1"],["b1"],["f-1","a1"],["c0"],["f0"],["c0","e1"],["f0"],["c0"],["f0"],["c0"],["g-1"],["d0"],["g0"],["d0","b1"],["g0","a1"],["d0","b1"],["g0","a1"],["d0","b1"],["a-1"],["e0","a1"],["a0"],["e0","e1"],["a0"],["e0"],["a0"],["e0"],["a0"],["e0"],["a0"],["b1"],["a1"],["b1"],["a1"],["b1"],["f-1","a1"],["c0"],["a0"],["c0","e1"],["a0"],["c0"],["a0"],["c0"],["g-1"],["d0"],["g0"],["d0","b1"],["g0","b1"],["d0","b1"],["g0","c2"],["d0","b1"],["a-1","b1"],["e0","a1"],["a0"],["e0","e1"],["a0"],["e0"],["a0"],["e0"],["a0"],["__"],["__"],["__"],["c1"],["g1"],["c2"],["c1"],["g1"],["c2"],["c1"],["g1"],["c2"],["c1"],["g1"],["c2"],["g1"],["f0"],["g1"],["b1"],["f0"],["g1"],["b1"],["f0"],["g1"],["b1"],["f0"],["g1"],["b1"],["f0"],["g1"],["b1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["b1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["b1"],["e1"],["c1"],["g1"],["c2"],["c0"],["g1"],["c2"],["c0"],["g1"],["c2"],["c0"],["g1"],["c2"],["c0"],["g1"],["c2"],["g1"],["e1"],["g1"],["b1"],["e1"],["g1"],["b1"],["e1"],["g1"],["b1"],["e1"],["g1"],["b1"],["e1"],["g1"],["b1"],["g1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["f0"],["g1"],["b1"],["f0"],["g1"],["b1"],["f0"],["g1"],["b1"],["b0"],["c1"],["e1"],["g1"],["b1"],["c0"],["e1"],["c1"],["c0"],["e1"],["c1"],["c0"],["e1"],["c1"],["c0"],["e1"],["c1"],["c0"],["e1"],["c1"],["e1"],["g0"],["d1"],["b1"],["g0"],["d1"],["b1"],["g0"],["d1"],["b1"],["g0"],["d1"],["b1"],["g0"],["d1"],["b1"],["d1"],["a0"],["c1"],["a1"],["a0"],["c1"],["a1"],["a0"],["c1"],["a1"],["a0"],["c1"],["a1"],["c1"],["a0"],["c1"],["a1"],["a0"],["c1"],["a1"],["__"],["b0"],["c1"],["e1"],["g1"],["b1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["e1"],["d0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["__"],["e0"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["__"],["__"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["f-1","a1"],["c0"],["f0"],["f1"],["f1"],["f1"],["g-1"],["d0"],["g0"],["b1"],["a1"],["b1"],["a1"],["b1"],["a0","b1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b1"],["a1"],["b1"],["a1"],["b1"],["f-1","a1"],["f0"],["e1"],["a1"],["f0"],["e1"],["a1"],["e1"],["g-1"],["g0"],["e1"],["b1"],["b1"],["b1"],["c2"],["b1"],["a-1","b1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b1"],["a1"],["b1"],["a1"],["b1"],["a1"],["b1"],["f-1","a1"],["f0"],["e0"],["e1"],["a1"],["e0"],["e1"],["a1"],["e1"],["g-1"],["g0"],["e1"],["b1"],["a1"],["b1"],["a1"],["b1"],["a-1"],["b1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["f-1","a1"],["f0"],["e1"],["a1"],["f0"],["e1"],["a1"],["e1"],["f-1"],["f0"],["e1"],["b1"],["b1"],["b1"],["c2"],["b1"],["a-1","b1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["__"],["__"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["a0"],["e1"],["a1"],["g0"],["e1"],["a1"],["b0"],["e1"],["a1"],["g0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["e1"],["a0"],["e1"],["a1"],["a0"],["e1"],["a1"],["__"],["__"],["b0"],["c1"],["e1"],["g1"],["b1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["f0"],["e1"],["a1"],["a0"],["e1"],["a1"],["b0"],["e1"],["a1"],["b0"],["e1"],["a1"],["b0"],["c1"],["e1"],["g1"],["b1"],["__"],["__"]];document.body.classList.add("loading");var sounds={c:{sound:"Piano.ff.C",shape:2,buffer:null,color:"w"},bd:{sound:"Piano.ff.Db",shape:3,buffer:null,color:"b"},d:{sound:"Piano.ff.D",shape:1,buffer:null,color:"w"},be:{sound:"Piano.ff.Eb",shape:3,buffer:null,color:"b"},e:{sound:"Piano.ff.E",shape:0,buffer:null,color:"w"},f:{sound:"Piano.ff.F",shape:2,buffer:null,color:"w"},bg:{sound:"Piano.ff.Gb",shape:3,buffer:null,color:"b"},g:{sound:"Piano.ff.G",shape:1,buffer:null,color:"w"},ba:{sound:"Piano.ff.Ab",shape:3,buffer:null,color:"b"},a:{sound:"Piano.ff.A",shape:1,buffer:null,color:"w"},bb:{sound:"Piano.ff.Bb",shape:3,buffer:null,color:"b"},b:{sound:"Piano.ff.B",shape:0,buffer:null,color:"w"}},cubeCamera,white_material,black_material,main_color=11184810,time=0,canvas_height=window.innerHeight,canvas_width=window.innerWidth,basepath="assets/sounds/",bufferLoader,spotLight;window.AudioContext=window.AudioContext||window.webkitAudioContext;var audioContext=new AudioContext,bufferLoader=new AudioBufferLoader(audioContext),scene,camera,renderer,controls,maxNotes=84,manager=new THREE.LoadingManager;manager.onProgress=function(e,a,o){console.log(e,a,o),a==o&&init()};var loader=new THREE.JSONLoader(manager),textureLoader=new THREE.TextureLoader(manager),pianoNotes={ready:!1,isPlaying:!1,recording:!1},playBoard=[],assets={shapes:{},texture:{},geometry:{},materials:{}},stage={x:window.innerWidth,y:window.innerHeight},notenOptions={violinPos:50,bassPos:100,violinOrigin:83,violineBase:5,bassBase:2,lineHeight:6};loader.load("assets/json/w_l.json",function(e,a){assets.shapes.w_l=e}),loader.load("assets/json/w_r_l.json",function(e,a){assets.shapes.w_r_l=e}),loader.load("assets/json/w_r.json",function(e,a){assets.shapes.w_r=e}),loader.load("assets/json/b.json",function(e,a){assets.shapes.b=e}),loader.load("assets/json/pianoGeometry.json",function(e,a){assets.geometry.piano=e,assets.materials.piano=a}),loader.load("assets/json/skyBox.json",function(e,a){assets.geometry.sky=e}),textureLoader.load("dist/textures/sky_texture.jpg",function(e){assets.texture.sky=e}),textureLoader.load("dist/textures/ground_albedo.jpg",function(e){assets.texture.ground_albedo=e}),textureLoader.load("dist/textures/ground_heightmap.jpg",function(e){assets.texture.ground_heightmap=e}),textureLoader.load("dist/textures/ground_normal.jpg",function(e){assets.texture.ground_normal=e}),window.onresize=function(){canvas_height=window.innerHeight,canvas_width=window.innerWidth,camera.aspect=canvas_width/canvas_height,camera.updateProjectionMatrix(),Adjust.resize(),renderer.setSize(canvas_width,canvas_height)};var render=function(e){requestAnimationFrame(render),controls.update(),animation(e),Adjust.update(),cubeCamera.updateCubeMap(renderer,scene),renderer.render(scene,camera)};