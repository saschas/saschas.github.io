function randNum(e,t,i){var o=Math.random()*t+e;return(i||"undefined"===i)&&(o*=1==Math.floor(2*Math.random())?1:-1),o}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function init(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,container=document.getElementById("container"),camera=new THREE.PerspectiveCamera(30,window.innerWidth/window.innerHeight,.1,1e4),camera.position.x=-650,camera.position.y=35,camera.position.z=-1600,camera.move_direction=1,scene=new THREE.Scene,scene.fog=new THREE.FogExp2(0,5e-4),scene.add(camera),controls=new THREE.OrbitControls(camera),controls.damping=.2,controls.addEventListener("change",render),camera.lookAt(new THREE.Vector3(0,50,0)),controls.target=new THREE.Vector3(0,50,0);var e=new THREE.AmbientLight(3355443);scene.add(e),pointLight=new THREE.SpotLight(15658734,2),pointLight.position.set(0,0,-1e3),pointLight.exponent=20,pointLight.castShadow=!0,pointLight.shadowMapWidth=1024,pointLight.shadowMapHeight=1024;var t=350;pointLight.shadowCameraLeft=-t,pointLight.shadowCameraRight=t,pointLight.shadowCameraTop=t,pointLight.shadowCameraBottom=-t,pointLight.shadowCameraNear=1,scene.add(pointLight),renderer=new THREE.WebGLRenderer({antialias:!0,transparent:!0,alpha:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement),renderer.shadowMapEnabled=!0,video=document.getElementById("myVideo"),video.addEventListener("progress",function(){var e=this.buffered.end(0)/this.duration;console.log(e)}),videoImage=document.createElement("canvas"),videoImage.width=960,videoImage.height=540,videoImageContext=videoImage.getContext("2d"),videoImageContext.fillStyle="#ffffff",videoImageContext.fillRect(0,0,videoImage.width,videoImage.height),videoTexture=new THREE.Texture(videoImage),videoTexture.minFilter=THREE.LinearFilter,videoTexture.magFilter=THREE.LinearFilter,videoTexture.wrapS=videoTexture.wrapT=THREE.ClampToEdgeWrapping;var i=new THREE.MeshPhongMaterial({color:16777215,map:videoTexture,wireframe:!1,shininess:0,transparent:!0,depthTest:!0,depthWrite:!0,alphaTest:.6,side:THREE.DoubleSide,shading:THREE.SmoothShading}),o=6,a=new THREE.PlaneGeometry(960/o,540/o,128),r={texture:{type:"t",value:videoTexture}},n=document.getElementById("vertexShaderDepth").textContent,d=document.getElementById("fragmentShaderDepth").textContent;plane=new THREE.Mesh(a,i),plane.customDepthMaterial=new THREE.ShaderMaterial({uniforms:r,vertexShader:n,fragmentShader:d}),plane.castShadow=!0,plane.frequencer=.1,plane.direction=1,plane.position.z=-250,plane.geometry.vertices.forEach(function(e,t){}),plane.update=function(e){var t=this;this.frequencer+=.001*this.direction,(this.frequencer>=.9||this.frequencer<=0)&&(this.direction*=-1),imageOptions.morph_video&&(this.geometry.vertices.forEach(function(e,i){e.z=10*Math.sin(t.frequencer*i)}),this.geometry.verticesNeedUpdate=!0)},scene.add(plane);var s=new THREE.PlaneGeometry(5e3,5e3,128,128),h=new THREE.MeshLambertMaterial({color:3355443,shading:THREE.FlatShading,side:THREE.DoubleSide});floor=new THREE.Mesh(s,h),floor.position.z=150,floor.receiveShadow=!0;for(var l=0;l<floor.geometry.vertices.length;l++)floor.geometry.vertices[l].z=20*Math.random();floor.geometry.verticesNeedUpdate=!0;var g=new THREE.WireframeHelper(floor,3355443);scene.add(g),scene.add(floor)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function animate(){requestAnimationFrame(animate),render()}function render(e){function t(e){e.drawImage(video,0,0,960,540);var t=e.getImageData(0,0,960,540);e.clearRect(0,0,960,540);for(var i=t.data,o=0;o<i.length;o+=4){if(imageOptions.threshold){var a=i[o],r=i[o+1],n=i[o+2],d=imageOptions.threshold_r*a+imageOptions.threshold_g*r+imageOptions.threshold_b*n>=imageOptions.threshold_value?255:0;0!=d||imageOptions.threshold_invert||(i[o+3]=0),255==d&&imageOptions.threshold_invert&&(i[o+3]=0)}imageOptions.overlay&&(i[o]=i[o]+imageOptions.overlay_r,i[o+1]=i[o+1]+imageOptions.overlay_g,i[o+2]=i[o+2]+imageOptions.overlay_b)}e.putImageData(t,0,0)}t(videoImageContext),videoTexture&&(videoTexture.needsUpdate=!0),plane.update(e),camera.lookAt(new THREE.Vector3(0,20,0)),renderer.render(scene,camera)}var container,camera,scene,controls,raycaster=new THREE.Raycaster,renderer,floor,pointLight,ImageOptions=function(){this.overlay_color="rgb(0, 128, 255,1)",this.overlay_r=0,this.overlay_g=128,this.overlay_b=255,this.overlay_a=1,this.overlay=!1,this.threshold=!0,this.threshold_invert=!0,this.threshold_value=188,this.threshold_r=.21,this.threshold_g=.71,this.threshold_b=.07,this.morph_video=!1,this.live_cam_input=function(){var e=function(e){console.log("Nope!",e)};navigator.getUserMedia?navigator.getUserMedia({audio:!1,video:!0},function(e){video.src=window.URL.createObjectURL(e)},e):video.src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/61062/passing_through.mp4"}},imageOptions=new ImageOptions,gui=new dat.GUI,overlay=gui.addFolder("Overlay"),threshold_f=gui.addFolder("Threshold"),overlay_color=overlay.addColor(imageOptions,"overlay_color");overlay.add(imageOptions,"overlay"),gui.add(imageOptions,"morph_video"),gui.add(imageOptions,"live_cam_input"),threshold_f.add(imageOptions,"threshold"),threshold_f.add(imageOptions,"threshold_value",0,255),threshold_f.add(imageOptions,"threshold_invert"),threshold_f.add(imageOptions,"threshold_r",0,2),threshold_f.add(imageOptions,"threshold_g",0,2),threshold_f.add(imageOptions,"threshold_b",0,2),overlay_color.onChange(function(e){var t=hexToRgb(e);imageOptions.overlay_r=t.r,imageOptions.overlay_g=t.g,imageOptions.overlay_b=t.b}),init(),animate(),window.addEventListener("resize",onWindowResize,!1);